<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <meta name="theme-color" content="#059669" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <title>سهل إيطالي - SahlItaly</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #059669;
            --primary-dark: #047857;
            --primary-light: #10B981;
            --secondary: #8B5CF6;
            --accent: #F59E0B;
            --success: #22C55E;
            --danger: #EF4444;
            --warning: #F59E0B;
            --info: #06B6D4;
            --a1-color: #22C55E;
            --a2-color: #3B82F6;
            --b1-color: #F59E0B;
            --b2-color: #EF4444;
            --dark: #1F2937;
            --light: #F9FAFB;
            --card-bg: #FFFFFF;
            --text-main: #1F2937;
            --text-secondary: #6B7280;
            --border: #E5E7EB;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
            --radius: 16px;
            --radius-sm: 10px;
            --nav-height: 65px;
            --safe-bottom: env(safe-area-inset-bottom, 0px);
        }

        body.dark-mode {
            --dark: #111827; --light: #1F2937; --card-bg: #374151;
            --text-main: #F3F4F6; --text-secondary: #9CA3AF; --border: #4B5563;
            background: linear-gradient(135deg, #111827 0%, #1F2937 100%);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Tajawal', sans-serif; -webkit-tap-highlight-color: transparent; }
        html, body { height: 100%; overflow: hidden; }
        body { background: linear-gradient(135deg, #ECFDF5 0%, #D1FAE5 100%); color: var(--text-main); }
        .italian-text, .italian-text-center { direction: ltr; unicode-bidi: bidi-override; }
        .italian-text-center { text-align: center; }

        /* Loading & Offline */
        .loading-overlay { position: fixed; inset: 0; background: linear-gradient(135deg, #059669 0%, #047857 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 99999; transition: opacity 0.5s, visibility 0.5s; }
        .loading-overlay.hide { opacity: 0; visibility: hidden; }
        .loading-spinner { width: 50px; height: 50px; border: 4px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { color: white; font-size: 18px; font-weight: 700; }
        .mini-loader { position: fixed; top: 70px; left: 50%; transform: translateX(-50%); background: var(--primary); color: white; padding: 8px 16px; border-radius: 20px; font-size: 12px; z-index: 9999; display: flex; align-items: center; gap: 8px; box-shadow: var(--shadow); }
        .offline-banner { position: fixed; top: 0; left: 0; right: 0; background: var(--warning); color: white; padding: 8px; text-align: center; font-size: 12px; font-weight: 600; z-index: 99999; display: none; }
        .offline-banner.show { display: block; }

        /* App Layout */
        .app-wrapper { display: flex; flex-direction: column; height: 100dvh; overflow: hidden; }
        .app-header { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; padding: 12px 15px; padding-top: calc(12px + env(safe-area-inset-top)); flex-shrink: 0; z-index: 100; }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .header-logo { display: flex; align-items: center; gap: 10px; }
        .header-logo-icon { width: 36px; height: 36px; background: rgba(255,255,255,0.2); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 18px; }
        .header-title { font-size: 18px; font-weight: 800; }
        .header-subtitle { font-size: 10px; opacity: 0.9; }
        .header-actions { display: flex; gap: 8px; }
        .header-btn { width: 36px; height: 36px; border-radius: 10px; border: none; background: rgba(255,255,255,0.2); color: white; font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; position: relative; }
        .header-btn:active { transform: scale(0.95); }
        .header-btn .badge { position: absolute; top: -2px; right: -2px; background: var(--danger); color: white; font-size: 8px; font-weight: 700; width: 16px; height: 16px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .stats-bar { display: flex; gap: 8px; }
        .stat-item { background: rgba(255,255,255,0.2); padding: 5px 10px; border-radius: 15px; font-size: 11px; font-weight: 600; display: flex; align-items: center; gap: 4px; }

        /* Main Content */
        .main-content { flex: 1; overflow-y: auto; overflow-x: hidden; -webkit-overflow-scrolling: touch; padding-bottom: calc(var(--nav-height) + var(--safe-bottom) + 15px); }
        .page { display: none; padding: 15px; }
        .page.active { display: block; animation: fadeIn 0.2s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Bottom Nav */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; height: calc(var(--nav-height) + var(--safe-bottom)); background: var(--card-bg); display: flex; justify-content: space-around; align-items: flex-start; padding-top: 8px; padding-bottom: var(--safe-bottom); box-shadow: 0 -2px 20px rgba(0,0,0,0.08); z-index: 9999; border-top: 1px solid var(--border); }
        .nav-item { display: flex; flex-direction: column; align-items: center; padding: 6px 10px; color: var(--text-secondary); font-size: 10px; font-weight: 600; cursor: pointer; border: none; background: none; min-width: 55px; position: relative; }
        .nav-item i { font-size: 20px; margin-bottom: 3px; }
        .nav-item.active { color: var(--primary); }
        .nav-item.active i { transform: scale(1.15); }
        .nav-item.active::before { content: ''; position: absolute; top: -8px; left: 50%; transform: translateX(-50%); width: 35px; height: 3px; background: var(--primary); border-radius: 0 0 3px 3px; }

        /* Cards & Components */
        .card { background: var(--card-bg); border-radius: var(--radius); padding: 15px; box-shadow: var(--shadow); margin-bottom: 12px; }
        .card-title { font-size: 13px; font-weight: 700; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }

        /* Word of Day */
        .word-of-day { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: var(--radius); color: white; box-shadow: var(--shadow-lg); overflow: hidden; margin-bottom: 12px; }
        .word-of-day.collapsed .wod-content { display: none; }
        .word-of-day.collapsed .wod-collapsed { display: flex; }
        .wod-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; }
        .wod-badge { background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; }
        .wod-date { font-size: 9px; opacity: 0.8; margin-top: 2px; }
        .wod-actions { display: flex; gap: 6px; }
        .wod-btn { width: 28px; height: 28px; border-radius: 50%; border: none; background: rgba(255,255,255,0.2); color: white; font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .wod-btn.liked { background: var(--danger); }
        .wod-content { padding: 0 12px 12px; text-align: center; }
        .wod-italian { font-size: 22px; font-weight: 800; margin-bottom: 3px; direction: ltr; }
        .wod-phonetic { font-size: 11px; opacity: 0.8; margin-bottom: 6px; font-style: italic; direction: ltr; }
        .wod-type { display: inline-block; background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 8px; font-size: 9px; margin-bottom: 8px; }
        .wod-arabic { font-size: 16px; font-weight: 600; padding: 8px; background: rgba(255,255,255,0.1); border-radius: var(--radius-sm); margin-bottom: 8px; }
        .wod-example { background: rgba(0,0,0,0.2); padding: 8px 10px; border-radius: var(--radius-sm); text-align: center; }
        .wod-example-label { font-size: 9px; opacity: 0.7; margin-bottom: 3px; }
        .wod-example-it { font-size: 12px; font-weight: 600; margin-bottom: 2px; direction: ltr; }
        .wod-example-ar { font-size: 11px; opacity: 0.9; }
        .wod-collapsed { display: none; padding: 0 12px 10px; align-items: center; justify-content: space-between; }
        .wod-collapsed-text { display: flex; align-items: center; gap: 8px; }
        .wod-collapsed-word { font-size: 14px; font-weight: 700; direction: ltr; }
        .wod-collapsed-meaning { font-size: 12px; opacity: 0.9; }
        .wod-expand-btn { background: rgba(255,255,255,0.2); border: none; color: white; padding: 5px 10px; border-radius: 12px; font-size: 10px; cursor: pointer; }

        /* Daily Goal */
        .daily-goal { background: linear-gradient(135deg, var(--accent), #FB923C); color: white; border-radius: var(--radius); padding: 12px 15px; margin-bottom: 12px; }
        .daily-goal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .daily-goal-title { font-size: 13px; font-weight: 700; }
        .daily-goal-xp { font-size: 12px; }
        .daily-goal-progress { height: 6px; background: rgba(255,255,255,0.3); border-radius: 3px; overflow: hidden; }
        .daily-goal-fill { height: 100%; background: white; border-radius: 3px; transition: width 0.3s; }

        /* Level Selector */
        .level-tabs { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .level-tab { padding: 12px 8px; border: 2px solid var(--border); border-radius: var(--radius-sm); background: var(--light); text-align: center; cursor: pointer; font-weight: 700; font-size: 14px; transition: all 0.2s; }
        .level-tab.a1 { border-color: var(--a1-color); color: var(--a1-color); }
        .level-tab.a2 { border-color: var(--a2-color); color: var(--a2-color); }
        .level-tab.b1 { border-color: var(--b1-color); color: var(--b1-color); }
        .level-tab.b2 { border-color: var(--b2-color); color: var(--b2-color); }
        .level-tab.active.a1 { background: var(--a1-color); color: white; box-shadow: 0 4px 12px rgba(34, 197, 94, 0.4); }
        .level-tab.active.a2 { background: var(--a2-color); color: white; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4); }
        .level-tab.active.b1 { background: var(--b1-color); color: white; box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4); }
        .level-tab.active.b2 { background: var(--b2-color); color: white; box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4); }
        .level-tab:active { transform: scale(0.95); }
        .level-tab small { display: block; font-size: 9px; margin-top: 2px; opacity: 0.8; }
        .level-tab .level-progress-bar { width: 100%; height: 4px; background: rgba(0,0,0,0.1); border-radius: 2px; margin-top: 6px; overflow: hidden; }
        .level-tab.active .level-progress-bar { background: rgba(255,255,255,0.3); }
        .level-progress-fill { height: 100%; border-radius: 2px; }
        .level-tab.active .level-progress-fill { background: white; }
        .level-tab.a1:not(.active) .level-progress-fill { background: var(--a1-color); }
        .level-tab.a2:not(.active) .level-progress-fill { background: var(--a2-color); }
        .level-tab.b1:not(.active) .level-progress-fill { background: var(--b1-color); }
        .level-tab.b2:not(.active) .level-progress-fill { background: var(--b2-color); }

        /* Progress */
        .progress-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .progress-title { font-size: 13px; font-weight: 700; }
        .progress-percentage { font-size: 16px; font-weight: 800; color: var(--primary); }
        .progress-bar { height: 8px; background: var(--border); border-radius: 4px; overflow: hidden; margin-bottom: 12px; }
        .progress-bar-fill { height: 100%; border-radius: 4px; transition: width 0.5s; }
        .progress-bar-fill.a1 { background: linear-gradient(to right, var(--a1-color), #4ADE80); }
        .progress-bar-fill.a2 { background: linear-gradient(to right, var(--a2-color), #60A5FA); }
        .progress-bar-fill.b1 { background: linear-gradient(to right, var(--b1-color), #FBBF24); }
        .progress-bar-fill.b2 { background: linear-gradient(to right, var(--b2-color), #F87171); }
        .progress-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .progress-stat { text-align: center; padding: 8px; background: var(--light); border-radius: var(--radius-sm); }
        .progress-stat-value { font-size: 16px; font-weight: 800; color: var(--primary); }
        .progress-stat-label { font-size: 9px; color: var(--text-secondary); }

        /* Section Grid */
        .section-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .section-card { background: var(--card-bg); border-radius: var(--radius); padding: 15px; text-align: center; cursor: pointer; box-shadow: var(--shadow); position: relative; overflow: hidden; }
        .section-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; }
        .section-card.words::before { background: var(--a1-color); }
        .section-card.phrases::before { background: var(--a2-color); }
        .section-card.conversations::before { background: var(--b1-color); }
        .section-card.grammar::before { background: var(--b2-color); }
        .section-card.quiz::before { background: var(--secondary); }
        .section-card.practice::before { background: var(--accent); }
        .section-card:active { transform: scale(0.97); }
        .section-card-icon { width: 45px; height: 45px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px; margin: 0 auto 10px; color: white; }
        .section-card.words .section-card-icon { background: linear-gradient(135deg, var(--a1-color), #4ADE80); }
        .section-card.phrases .section-card-icon { background: linear-gradient(135deg, var(--a2-color), #60A5FA); }
        .section-card.conversations .section-card-icon { background: linear-gradient(135deg, var(--b1-color), #FBBF24); }
        .section-card.grammar .section-card-icon { background: linear-gradient(135deg, var(--b2-color), #F87171); }
        .section-card.quiz .section-card-icon { background: linear-gradient(135deg, var(--secondary), #A855F7); }
        .section-card.practice .section-card-icon { background: linear-gradient(135deg, var(--accent), #FB923C); }
        .section-card-title { font-size: 13px; font-weight: 700; margin-bottom: 3px; }
        .section-card-count { font-size: 10px; color: var(--text-secondary); }
        .section-card-badge { position: absolute; top: 8px; left: 8px; background: var(--danger); color: white; font-size: 9px; font-weight: 700; padding: 2px 6px; border-radius: 8px; }

        /* Search Box */
        .search-box { background: var(--card-bg); border-radius: var(--radius-sm); padding: 10px 12px; display: flex; align-items: center; gap: 10px; margin-bottom: 12px; box-shadow: var(--shadow); }
        .search-box input { flex: 1; border: none; background: none; font-size: 14px; color: var(--text-main); outline: none; }
        .search-box input::placeholder { color: var(--text-secondary); }

        /* Page Header */
        .page-header { display: flex; align-items: center; gap: 12px; margin-bottom: 15px; padding-bottom: 12px; border-bottom: 1px solid var(--border); }
        .page-back { width: 38px; height: 38px; border-radius: 10px; border: none; background: var(--light); color: var(--text-main); font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .page-title { font-size: 18px; font-weight: 800; }
        .page-subtitle { font-size: 11px; color: var(--text-secondary); }

        /* Category List */
        .category-list { display: flex; flex-direction: column; gap: 10px; }
        .category-item { background: var(--card-bg); border-radius: var(--radius-sm); padding: 12px; display: flex; align-items: center; gap: 12px; cursor: pointer; box-shadow: var(--shadow); }
        .category-item:active { transform: scale(0.98); }
        .category-icon { width: 45px; height: 45px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px; flex-shrink: 0; }
        .category-info { flex: 1; min-width: 0; }
        .category-name { font-size: 14px; font-weight: 700; margin-bottom: 2px; }
        .category-meta { font-size: 11px; color: var(--text-secondary); }
        .category-progress { font-size: 14px; font-weight: 800; color: var(--primary); }
        .category-arrow { color: var(--text-secondary); font-size: 12px; }

        /* Word Card */
        .word-card-container { perspective: 1500px; height: 260px; margin-bottom: 15px; }
        .word-card { position: relative; width: 100%; height: 100%; transition: transform 0.6s; transform-style: preserve-3d; cursor: pointer; }
        .word-card.flipped { transform: rotateY(180deg); }
        .word-card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: var(--radius); padding: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: var(--shadow-lg); }
        .word-card-front { background: var(--card-bg); border: 2px solid var(--border); }
        .word-card-back { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; transform: rotateY(180deg); }
        .word-level-badge { position: absolute; top: 12px; left: 12px; padding: 4px 10px; border-radius: 12px; font-size: 10px; font-weight: 700; color: white; }
        .word-level-badge.a1 { background: var(--a1-color); }
        .word-level-badge.a2 { background: var(--a2-color); }
        .word-level-badge.b1 { background: var(--b1-color); }
        .word-level-badge.b2 { background: var(--b2-color); }
        .word-type-badge { position: absolute; top: 12px; right: 12px; padding: 4px 10px; border-radius: 12px; font-size: 10px; font-weight: 600; background: rgba(0,0,0,0.05); }
        .word-main { font-size: 28px; font-weight: 800; margin-bottom: 8px; text-align: center; direction: ltr; }
        .word-phonetic { font-size: 13px; color: var(--text-secondary); font-style: italic; direction: ltr; }
        .word-translation { font-size: 24px; font-weight: 700; text-align: center; margin-bottom: 12px; }
        .word-example { font-size: 13px; text-align: center; padding: 10px; background: rgba(255,255,255,0.1); border-radius: var(--radius-sm); line-height: 1.5; width: 100%; }
        .word-card-hint { position: absolute; bottom: 12px; font-size: 11px; opacity: 0.6; }

        /* Controls */
        .word-controls { display: flex; gap: 8px; margin-bottom: 12px; }
        .btn { padding: 10px; border: none; border-radius: var(--radius-sm); font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px; font-family: 'Tajawal', sans-serif; flex: 1; }
        .btn:active { transform: scale(0.95); opacity: 0.9; }
        .btn:disabled { opacity: 0.5; pointer-events: none; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-secondary { background: var(--light); color: var(--text-main); border: 2px solid var(--border); }

        /* Rating */
        .rating-buttons { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; }
        .rating-btn { padding: 10px 5px; border: none; border-radius: var(--radius-sm); font-size: 11px; font-weight: 600; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 3px; }
        .rating-btn.again { background: rgba(239, 68, 68, 0.1); color: var(--danger); }
        .rating-btn.hard { background: rgba(245, 158, 11, 0.1); color: var(--warning); }
        .rating-btn.good { background: rgba(59, 130, 246, 0.1); color: var(--info); }
        .rating-btn.easy { background: rgba(34, 197, 94, 0.1); color: var(--success); }
        .rating-btn:active { transform: scale(0.95); }

        /* Quiz */
        .quiz-progress { display: flex; align-items: center; margin-bottom: 15px; font-weight: 700; font-size: 13px; }
        .quiz-progress-bar { flex: 1; height: 6px; background: var(--border); border-radius: 3px; margin: 0 10px; overflow: hidden; }
        .quiz-progress-fill { height: 100%; background: var(--primary); border-radius: 3px; }
        .quiz-question { text-align: center; margin-bottom: 20px; }
        .quiz-question-text { font-size: 20px; font-weight: 700; margin-bottom: 8px; }
        .quiz-question-hint { font-size: 12px; color: var(--text-secondary); }
        .quiz-options { display: flex; flex-direction: column; gap: 8px; margin-bottom: 15px; }
        .quiz-option { padding: 12px; border: 2px solid var(--border); border-radius: var(--radius-sm); font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 10px; }
        .quiz-option.selected { border-color: var(--primary); background: rgba(5, 150, 105, 0.1); }
        .quiz-option.correct { border-color: var(--success); background: rgba(34, 197, 94, 0.1); }
        .quiz-option.wrong { border-color: var(--danger); background: rgba(239, 68, 68, 0.1); }
        .quiz-option.disabled { pointer-events: none; }
        .quiz-option-letter { width: 28px; height: 28px; border-radius: 50%; background: var(--light); display: flex; align-items: center; justify-content: center; font-size: 13px; }
        .quiz-option.selected .quiz-option-letter { background: var(--primary); color: white; }
        .quiz-option.correct .quiz-option-letter { background: var(--success); color: white; }
        .quiz-option.wrong .quiz-option-letter { background: var(--danger); color: white; }
        .quiz-option-text { flex: 1; }
        .quiz-option-speak { width: 30px; height: 30px; border-radius: 50%; border: none; background: var(--primary); color: white; cursor: pointer; }
        .quiz-result { text-align: center; padding: 20px; }
        .quiz-result-icon { font-size: 50px; margin-bottom: 15px; }
        .quiz-result-title { font-size: 22px; font-weight: 800; margin-bottom: 8px; }
        .quiz-result-score { font-size: 16px; color: var(--text-secondary); margin-bottom: 15px; }
        .quiz-result-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px; }
        .quiz-result-stat { background: var(--light); padding: 12px; border-radius: var(--radius-sm); }
        .quiz-result-stat-value { font-size: 20px; font-weight: 800; }
        .quiz-result-stat-label { font-size: 11px; color: var(--text-secondary); }

        /* Voice */
        .voice-btn { width: 60px; height: 60px; border-radius: 50%; border: none; background: linear-gradient(135deg, var(--secondary), #A855F7); color: white; font-size: 24px; cursor: pointer; margin: 15px auto; box-shadow: var(--shadow-lg); display: flex; align-items: center; justify-content: center; }
        .voice-btn:active { transform: scale(0.95); }
        .voice-btn.listening { animation: pulse 1s infinite; background: linear-gradient(135deg, var(--danger), #F87171); }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        .voice-result { text-align: center; padding: 10px; background: var(--light); border-radius: var(--radius-sm); margin-top: 10px; font-size: 14px; font-weight: 600; }

        /* Profile */
        .profile-header { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; border-radius: var(--radius); padding: 20px; text-align: center; margin-bottom: 15px; }
        .profile-avatar { width: 70px; height: 70px; background: rgba(255,255,255,0.2); border-radius: 50%; margin: 0 auto 12px; display: flex; align-items: center; justify-content: center; font-size: 32px; }
        .profile-level { font-size: 22px; font-weight: 800; }
        .profile-xp { font-size: 14px; opacity: 0.9; margin-bottom: 12px; }
        .profile-progress { height: 5px; background: rgba(255,255,255,0.3); border-radius: 3px; overflow: hidden; margin-bottom: 5px; }
        .profile-progress-fill { height: 100%; background: white; border-radius: 3px; }
        .profile-next { font-size: 10px; opacity: 0.8; }

        /* Favorites */
        .favorites-header { background: linear-gradient(135deg, #ec4899, #f43f5e); color: white; border-radius: var(--radius); padding: 20px; text-align: center; margin-bottom: 15px; }
        .favorites-icon { font-size: 40px; margin-bottom: 10px; }
        .favorites-count { font-size: 24px; font-weight: 800; }
        .favorites-label { font-size: 12px; opacity: 0.9; }
        .favorites-actions { display: flex; gap: 10px; margin-top: 15px; }
        .favorites-action-btn { flex: 1; padding: 10px; border: none; border-radius: var(--radius-sm); background: rgba(255,255,255,0.2); color: white; font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .favorites-empty { text-align: center; padding: 40px 20px; color: var(--text-secondary); }
        .favorites-empty i { font-size: 50px; margin-bottom: 15px; opacity: 0.3; }

        /* Word List */
        .word-list-item { background: var(--light); border-radius: var(--radius-sm); padding: 12px; display: flex; align-items: center; gap: 12px; margin-bottom: 8px; }
        .word-list-item:active { transform: scale(0.98); }
        .word-list-level { width: 35px; height: 35px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 800; color: white; flex-shrink: 0; }
        .word-list-level.a1 { background: var(--a1-color); }
        .word-list-level.a2 { background: var(--a2-color); }
        .word-list-level.b1 { background: var(--b1-color); }
        .word-list-level.b2 { background: var(--b2-color); }
        .word-list-info { flex: 1; min-width: 0; }
        .word-list-italian { font-size: 15px; font-weight: 700; color: var(--text-main); direction: ltr; text-align: right; }
        .word-list-arabic { font-size: 12px; color: var(--text-secondary); }
        .word-list-category { font-size: 9px; color: var(--text-secondary); background: var(--light); padding: 2px 6px; border-radius: 4px; margin-top: 3px; display: inline-block; }
        .word-list-actions { display: flex; gap: 5px; }
        .word-list-btn { width: 32px; height: 32px; border-radius: 8px; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 14px; }
        .word-list-btn:active { transform: scale(0.9); }
        .word-list-btn.speak { background: var(--light); color: var(--primary); }
        .word-list-btn.like { background: rgba(239, 68, 68, 0.1); color: var(--text-secondary); }
        .word-list-btn.like.liked { background: var(--danger); color: white; }

        /* Dictionary */
        .dict-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 15px; }
        .dict-stat { text-align: center; padding: 10px; background: var(--light); border-radius: var(--radius-sm); cursor: pointer; border: 2px solid transparent; }
        .dict-stat.active { border-color: var(--primary); background: rgba(5, 150, 105, 0.1); }
        .dict-stat-value { font-size: 18px; font-weight: 800; }
        .dict-stat-label { font-size: 9px; color: var(--text-secondary); }
        .dict-stat.a1 .dict-stat-value { color: var(--a1-color); }
        .dict-stat.a2 .dict-stat-value { color: var(--a2-color); }
        .dict-stat.b1 .dict-stat-value { color: var(--b1-color); }
        .dict-stat.b2 .dict-stat-value { color: var(--b2-color); }
        .dict-category { background: var(--card-bg); border-radius: var(--radius); margin-bottom: 12px; box-shadow: var(--shadow); overflow: hidden; }
        .dict-category-header { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; cursor: pointer; background: var(--light); }
        .dict-category-header:active { background: var(--border); }
        .dict-category-info { display: flex; align-items: center; gap: 12px; flex: 1; }
        .dict-category-icon { width: 46px; height: 46px; min-width: 46px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px; color: white; box-shadow: 0 3px 10px rgba(0,0,0,0.15); }
        .dict-category-text h3 { font-size: 15px; font-weight: 700; margin-bottom: 3px; color: var(--text-main); }
        .dict-category-text span { font-size: 12px; color: var(--text-secondary); }
        .dict-category-toggle { font-size: 14px; color: var(--text-secondary); transition: transform 0.3s; }
        .dict-category.open .dict-category-toggle { transform: rotate(180deg); }
        .dict-category-content { max-height: 0; overflow: hidden; transition: max-height 0.3s; }
        .dict-category.open .dict-category-content { max-height: 2000px; padding: 10px 15px 15px; }

        /* Toast */
        .toast { position: fixed; bottom: calc(var(--nav-height) + var(--safe-bottom) + 20px); left: 50%; transform: translateX(-50%) translateY(100px); background: var(--dark); color: white; padding: 10px 20px; border-radius: 25px; z-index: 10000; opacity: 0; transition: all 0.3s; font-size: 13px; font-weight: 600; display: flex; align-items: center; gap: 8px; pointer-events: none; }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }
        .toast.warning { background: var(--warning); }
        .toast.info { background: var(--info); }

        /* Modal */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 10001; opacity: 0; visibility: hidden; transition: all 0.3s; }
        .modal-overlay.show { opacity: 1; visibility: visible; }
        .modal { position: fixed; bottom: 0; left: 0; right: 0; background: var(--card-bg); border-radius: var(--radius) var(--radius) 0 0; padding: 20px; padding-bottom: calc(20px + var(--safe-bottom)); z-index: 10002; transform: translateY(100%); transition: transform 0.3s; max-height: 85vh; overflow-y: auto; }
        .modal.show { transform: translateY(0); }
        .modal-handle { width: 40px; height: 5px; background: var(--border); border-radius: 3px; margin: 0 auto 15px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--border); }
        .modal-title { font-size: 18px; font-weight: 800; color: var(--text-main); }
        .modal-close { width: 36px; height: 36px; border-radius: 50%; border: none; background: var(--light); font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--text-secondary); }

        /* Settings */
        .settings-section { margin-bottom: 24px; }
        .settings-title { font-size: 12px; font-weight: 700; color: var(--primary); text-transform: uppercase; margin-bottom: 12px; padding-right: 5px; letter-spacing: 0.5px; }
        .settings-item { display: flex; justify-content: space-between; align-items: center; padding: 14px 12px; border-radius: var(--radius-sm); background: var(--light); margin-bottom: 8px; cursor: pointer; }
        .settings-item:active { transform: scale(0.98); }
        .settings-item-info { display: flex; align-items: center; gap: 12px; }
        .settings-item-icon { width: 40px; height: 40px; border-radius: 10px; background: var(--card-bg); display: flex; align-items: center; justify-content: center; font-size: 18px; color: var(--primary); }
        .settings-item-text h4 { font-size: 14px; font-weight: 600; margin-bottom: 3px; color: var(--text-main); }
        .settings-item-text p { font-size: 12px; color: var(--text-secondary); }
        .toggle { width: 48px; height: 26px; background: var(--border); border-radius: 13px; position: relative; cursor: pointer; flex-shrink: 0; }
        .toggle.active { background: var(--primary); }
        .toggle::after { content: ''; position: absolute; top: 3px; left: 3px; width: 20px; height: 20px; background: white; border-radius: 50%; transition: left 0.3s; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .toggle.active::after { left: 25px; }
        .social-links { display: flex; justify-content: center; gap: 20px; padding: 20px; background: var(--light); border-radius: var(--radius-sm); }
        .social-link { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 22px; color: white; text-decoration: none; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .social-link:active { transform: scale(0.95); }
        .social-link.facebook { background: linear-gradient(135deg, #1877F2, #0D65D9); }
        .social-link.instagram { background: linear-gradient(45deg, #f09433, #dc2743, #bc1888); }
        .social-link.tiktok { background: linear-gradient(135deg, #010101, #69C9D0); }
        .app-version { text-align: center; padding: 15px; color: var(--text-secondary); font-size: 12px; }

        /* Info Page */
        .info-content { background: var(--card-bg); border-radius: var(--radius); padding: 20px; }
        .info-content h2 { font-size: 18px; font-weight: 700; color: var(--primary); margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        .info-content p { font-size: 14px; line-height: 1.8; color: var(--text-main); margin-bottom: 12px; }
        .info-content ul { padding-right: 20px; margin-bottom: 15px; }
        .info-content li { font-size: 14px; line-height: 1.8; margin-bottom: 8px; }
        .info-section { margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--border); }
        .info-section:last-child { border-bottom: none; }
        .info-section-title { font-size: 15px; font-weight: 700; margin-bottom: 10px; }
        .contact-item { display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--light); border-radius: var(--radius-sm); margin-bottom: 10px; cursor: pointer; }
        .contact-item:active { background: var(--border); }
        .contact-item i { width: 40px; height: 40px; border-radius: 10px; background: var(--primary); color: white; display: flex; align-items: center; justify-content: center; font-size: 18px; }
        .contact-item-text h4 { font-size: 14px; font-weight: 600; margin-bottom: 2px; }
        .contact-item-text p { font-size: 12px; color: var(--text-secondary); margin: 0; }

        /* Confirm Dialog */
        .confirm-dialog { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9); background: var(--card-bg); border-radius: var(--radius); padding: 20px; z-index: 10003; width: 85%; max-width: 320px; opacity: 0; visibility: hidden; transition: all 0.3s; text-align: center; }
        .confirm-dialog.show { transform: translate(-50%, -50%) scale(1); opacity: 1; visibility: visible; }
        .confirm-dialog-icon { font-size: 40px; margin-bottom: 12px; }
        .confirm-dialog-title { font-size: 16px; font-weight: 700; margin-bottom: 8px; }
        .confirm-dialog-text { font-size: 13px; color: var(--text-secondary); margin-bottom: 15px; }
        .confirm-dialog-buttons { display: flex; gap: 10px; }
        .confirm-dialog-btn { flex: 1; padding: 10px; border: none; border-radius: var(--radius-sm); font-size: 13px; font-weight: 600; cursor: pointer; }
        .confirm-dialog-btn.cancel { background: var(--light); color: var(--text-main); }
        .confirm-dialog-btn.confirm { background: var(--danger); color: white; }

        /* Phrase */
        .phrase-card { background: var(--card-bg); border-radius: var(--radius); padding: 15px; margin-bottom: 12px; box-shadow: var(--shadow); }
        .phrase-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; }
        .phrase-italian { font-size: 18px; font-weight: 700; color: var(--primary); margin-bottom: 5px; direction: ltr; text-align: right; }
        .phrase-arabic { font-size: 16px; color: var(--text-main); margin-bottom: 8px; }
        .phrase-phonetic { font-size: 12px; color: var(--text-secondary); font-style: italic; direction: ltr; text-align: right; }
        .phrase-speak { width: 40px; height: 40px; border-radius: 50%; border: none; background: var(--primary); color: white; font-size: 16px; cursor: pointer; flex-shrink: 0; }

        /* Conversation */
        .conv-container { padding: 10px; }
        .conv-bubble { padding: 12px 15px; border-radius: 15px; margin-bottom: 10px; max-width: 85%; position: relative; }
        .conv-bubble.person-a { background: var(--primary); color: white; margin-left: auto; border-bottom-right-radius: 5px; }
        .conv-bubble.person-b { background: var(--card-bg); border: 1px solid var(--border); margin-right: auto; border-bottom-left-radius: 5px; }
        .conv-speaker { font-size: 10px; font-weight: 700; margin-bottom: 5px; opacity: 0.8; }
        .conv-text-it { font-size: 14px; font-weight: 600; margin-bottom: 3px; direction: ltr; text-align: right; }
        .conv-text-ar { font-size: 12px; opacity: 0.9; }
        .conv-speak { position: absolute; top: 8px; left: 8px; width: 28px; height: 28px; border-radius: 50%; border: none; background: rgba(255,255,255,0.2); color: inherit; font-size: 12px; cursor: pointer; }
        .conv-bubble.person-b .conv-speak { background: var(--light); color: var(--primary); }
        .conv-controls { padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .conv-speed { display: flex; align-items: center; justify-content: center; gap: 10px; padding: 10px; background: var(--light); border-radius: var(--radius-sm); }
        .conv-speed-label { font-size: 12px; font-weight: 600; }
        .conv-speed-btn { width: 30px; height: 30px; border-radius: 50%; border: 2px solid var(--border); background: var(--card-bg); cursor: pointer; font-size: 10px; font-weight: 700; }
        .conv-speed-btn.active { border-color: var(--primary); background: var(--primary); color: white; }

        /* Grammar */
        .grammar-section { background: var(--card-bg); border-radius: var(--radius); padding: 15px; margin-bottom: 15px; box-shadow: var(--shadow); }
        .grammar-section-title { font-size: 16px; font-weight: 700; color: var(--primary); margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .grammar-table { width: 100%; border-collapse: collapse; }
        .grammar-table th, .grammar-table td { padding: 10px; text-align: center; border: 1px solid var(--border); }
        .grammar-table th { background: var(--primary); color: white; font-size: 12px; }
        .grammar-table td { font-size: 13px; background: var(--card-bg); }
        .grammar-table td.italian-cell { direction: ltr; font-weight: 700; color: var(--primary); }
        .grammar-example { background: var(--light); padding: 12px; border-radius: var(--radius-sm); margin-top: 10px; }
        .grammar-example-it { font-size: 14px; font-weight: 600; color: var(--primary); display: flex; align-items: center; gap: 10px; direction: ltr; }
        .grammar-example-ar { font-size: 12px; color: var(--text-secondary); margin-top: 5px; }

        /* Exercise */
        .exercise-card { background: var(--card-bg); border-radius: var(--radius); padding: 20px; margin-bottom: 15px; box-shadow: var(--shadow); }
        .exercise-title { font-size: 16px; font-weight: 700; margin-bottom: 15px; text-align: center; }
        .exercise-input { width: 100%; padding: 12px 15px; border: 2px solid var(--border); border-radius: var(--radius-sm); font-size: 16px; text-align: center; outline: none; margin-bottom: 15px; background: var(--card-bg); color: var(--text-main); direction: ltr; }
        .exercise-input:focus { border-color: var(--primary); }
        .exercise-input.correct { border-color: var(--success); background: rgba(34, 197, 94, 0.1); }
        .exercise-input.wrong { border-color: var(--danger); background: rgba(239, 68, 68, 0.1); }
        .exercise-hint { text-align: center; color: var(--text-secondary); font-size: 12px; margin-bottom: 10px; }
        .letter-tiles { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-bottom: 15px; direction: ltr; }
        .letter-tile { width: 40px; height: 40px; background: var(--light); border: 2px solid var(--border); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: 700; cursor: pointer; }
        .letter-tile:active { transform: scale(0.95); }
        .letter-tile.selected { background: var(--primary); border-color: var(--primary); color: white; }
        .letter-tile.disabled { opacity: 0.3; pointer-events: none; }
        .answer-tiles { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-bottom: 15px; min-height: 50px; padding: 10px; background: var(--light); border-radius: var(--radius-sm); direction: ltr; }
        .listening-btn { width: 80px; height: 80px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); border: none; color: white; font-size: 30px; cursor: pointer; margin-bottom: 20px; box-shadow: var(--shadow-lg); }
        .listening-btn:active { transform: scale(0.95); }

        /* Matching */
        .matching-game { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 10px; }
        .matching-card { aspect-ratio: 1; background: var(--light); border: 2px solid var(--border); border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; cursor: pointer; padding: 8px; text-align: center; user-select: none; }
        .matching-card.flipped { background: var(--primary); color: white; border-color: var(--primary); transform: scale(1.05); }
        .matching-card.matched { background: var(--success); border-color: var(--success); color: white; pointer-events: none; }
        .matching-card.wrong { animation: shake 0.4s; background: rgba(239, 68, 68, 0.2); border-color: var(--danger); }
        .matching-card.italian-card { direction: ltr; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 20%, 60% { transform: translateX(-8px); } 40%, 80% { transform: translateX(8px); } }
        .matching-stats { display: flex; justify-content: center; gap: 20px; padding: 10px; background: var(--light); border-radius: var(--radius-sm); margin-bottom: 15px; }
        .matching-stat { text-align: center; }
        .matching-stat-value { font-size: 20px; font-weight: 800; color: var(--primary); }
        .matching-stat-label { font-size: 10px; color: var(--text-secondary); }

        /* Achievements */
        .achievements-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .achievement-card { background: var(--card-bg); border-radius: var(--radius); padding: 15px; text-align: center; box-shadow: var(--shadow); position: relative; }
        .achievement-card.locked { opacity: 0.5; }
        .achievement-card.unlocked { border: 2px solid var(--accent); }
        .achievement-icon { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; margin: 0 auto 10px; background: var(--light); }
        .achievement-card.unlocked .achievement-icon { background: linear-gradient(135deg, var(--accent), #FB923C); }
        .achievement-title { font-size: 12px; font-weight: 700; margin-bottom: 4px; }
        .achievement-desc { font-size: 10px; color: var(--text-secondary); margin-bottom: 8px; }
        .achievement-progress { height: 4px; background: var(--border); border-radius: 2px; overflow: hidden; }
        .achievement-progress-fill { height: 100%; background: var(--accent); border-radius: 2px; }
        .achievement-badge { position: absolute; top: 8px; right: 8px; font-size: 14px; }
        .achievement-xp { position: absolute; top: 8px; left: 8px; background: var(--accent); color: white; font-size: 9px; font-weight: 700; padding: 2px 6px; border-radius: 8px; }

        /* Stats */
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .stat-box { background: var(--light); border-radius: var(--radius-sm); padding: 12px; text-align: center; }
        .stat-box-icon { font-size: 20px; margin-bottom: 5px; }
        .stat-box-value { font-size: 20px; font-weight: 800; color: var(--primary); }
        .stat-box-label { font-size: 10px; color: var(--text-secondary); }
        .weekly-chart { display: flex; justify-content: space-between; align-items: flex-end; height: 100px; padding: 10px 0; gap: 8px; }
        .chart-bar { flex: 1; background: var(--border); border-radius: 4px 4px 0 0; position: relative; min-height: 10px; }
        .chart-bar-fill { position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(to top, var(--primary), var(--primary-light)); border-radius: 4px 4px 0 0; }
        .chart-bar-label { position: absolute; bottom: -20px; left: 50%; transform: translateX(-50%); font-size: 9px; color: var(--text-secondary); }
        .level-progress-card { display: flex; gap: 10px; margin-bottom: 10px; }
        .level-progress-item { flex: 1; background: var(--light); border-radius: var(--radius-sm); padding: 10px; text-align: center; }
        .level-progress-label { font-size: 12px; font-weight: 700; margin-bottom: 5px; }
        .level-progress-bar-sm { height: 6px; background: var(--border); border-radius: 3px; overflow: hidden; margin-bottom: 5px; }
        .level-progress-value { font-size: 10px; color: var(--text-secondary); }

        /* Notifications */
        .notif-dropdown { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 10001; opacity: 0; visibility: hidden; transition: all 0.3s; }
        .notif-dropdown.show { opacity: 1; visibility: visible; }
        .notif-panel { position: absolute; top: calc(60px + env(safe-area-inset-top)); right: 15px; left: 15px; max-height: 70vh; background: var(--card-bg); border-radius: var(--radius); box-shadow: var(--shadow-lg); overflow: hidden; transform: translateY(-20px); opacity: 0; transition: all 0.3s; }
        .notif-dropdown.show .notif-panel { transform: translateY(0); opacity: 1; }
        .notif-header { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid var(--border); background: var(--light); }
        .notif-title { font-size: 16px; font-weight: 700; display: flex; align-items: center; gap: 8px; }
        .notif-clear { background: none; border: none; color: var(--danger); font-size: 12px; font-weight: 600; cursor: pointer; padding: 5px 10px; }
        .notif-list { max-height: calc(70vh - 60px); overflow-y: auto; }
        .notif-item { display: flex; gap: 12px; padding: 12px 15px; border-bottom: 1px solid var(--border); cursor: pointer; position: relative; }
        .notif-item.unread { background: rgba(5, 150, 105, 0.05); }
        .notif-item.unread::before { content: ''; position: absolute; right: 0; top: 50%; transform: translateY(-50%); width: 4px; height: 40px; background: var(--primary); border-radius: 0 4px 4px 0; }
        .notif-icon { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0; }
        .notif-icon.achievement { background: linear-gradient(135deg, #F59E0B, #FB923C); }
        .notif-icon.streak { background: linear-gradient(135deg, #EF4444, #F87171); }
        .notif-icon.xp { background: linear-gradient(135deg, #8B5CF6, #A855F7); }
        .notif-icon.reminder { background: linear-gradient(135deg, #06B6D4, #22D3EE); }
        .notif-icon.level { background: linear-gradient(135deg, #22C55E, #4ADE80); }
        .notif-content { flex: 1; min-width: 0; }
        .notif-text { font-size: 13px; font-weight: 600; color: var(--text-main); margin-bottom: 2px; }
        .notif-desc { font-size: 11px; color: var(--text-secondary); margin-bottom: 4px; }
        .notif-time { font-size: 10px; color: var(--text-secondary); }
        .notif-empty { text-align: center; padding: 40px 20px; color: var(--text-secondary); }
        .notif-empty i { font-size: 40px; margin-bottom: 10px; opacity: 0.5; }

        /* Empty State */
        .empty-state { text-align: center; padding: 30px; color: var(--text-secondary); }
        .empty-state i { font-size: 40px; margin-bottom: 12px; opacity: 0.5; }

        /* Liked Word */
        .liked-word-item { background: var(--card-bg); border-radius: var(--radius-sm); padding: 12px; display: flex; align-items: center; gap: 10px; margin-bottom: 8px; box-shadow: var(--shadow); }
        .liked-word-icon { width: 40px; height: 40px; background: linear-gradient(135deg, #ec4899, #f43f5e); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0; }
        .liked-word-info { flex: 1; }
        .liked-word-it { font-size: 14px; font-weight: 700; color: var(--text-main); direction: ltr; text-align: right; }
        .liked-word-ar { font-size: 12px; color: var(--text-secondary); }
        .liked-word-level { font-size: 9px; padding: 2px 6px; border-radius: 4px; color: white; margin-top: 3px; display: inline-block; }
        .liked-word-level.a1 { background: var(--a1-color); }
        .liked-word-level.a2 { background: var(--a2-color); }
        .liked-word-level.b1 { background: var(--b1-color); }
        .liked-word-level.b2 { background: var(--b2-color); }
        .liked-word-actions { display: flex; gap: 5px; }
        .liked-word-btn { width: 32px; height: 32px; border-radius: 8px; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 14px; }
        .liked-word-btn.speak { background: var(--light); color: var(--primary); }
        .liked-word-btn.delete { background: rgba(239, 68, 68, 0.1); color: var(--danger); }
        .liked-word-btn:active { transform: scale(0.95); }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">جاري تحميل البيانات...</div>
    </div>

    <div class="offline-banner" id="offlineBanner">📴 أنت غير متصل بالإنترنت</div>

    <div class="notif-dropdown" id="notifDropdown" onclick="if(event.target===this)this.classList.remove('show')">
        <div class="notif-panel" onclick="event.stopPropagation()">
            <div class="notif-header">
                <div class="notif-title"><i class="fas fa-bell"></i> الإشعارات</div>
                <button class="notif-clear" onclick="clearNotifications()">مسح الكل</button>
            </div>
            <div class="notif-list" id="notifList"></div>
        </div>
    </div>

    <div class="toast" id="toast"><i class="fas fa-check-circle"></i><span id="toastMsg"></span></div>

    <div class="modal-overlay" id="modalOverlay" onclick="closeAllModals()"></div>

    <div class="modal" id="settingsModal">
        <div class="modal-handle"></div>
        <div class="modal-header">
            <div class="modal-title">⚙️ الإعدادات</div>
            <button class="modal-close" onclick="closeModal('settingsModal')"><i class="fas fa-times"></i></button>
        </div>
        <div id="settingsContent"></div>
    </div>

    <div class="modal" id="infoModal">
        <div class="modal-handle"></div>
        <div class="modal-header">
            <div class="modal-title" id="infoModalTitle">معلومات</div>
            <button class="modal-close" onclick="closeModal('infoModal');openModal('settingsModal')"><i class="fas fa-times"></i></button>
        </div>
        <div id="infoModalContent"></div>
    </div>

    <div class="modal" id="achievementModal">
        <div class="modal-handle"></div>
        <div style="text-align:center;padding:20px;">
            <div style="font-size:60px;margin-bottom:15px;" id="achIcon">🏆</div>
            <div style="font-size:18px;font-weight:800;margin-bottom:8px;">إنجاز جديد!</div>
            <div style="font-size:16px;font-weight:600;margin-bottom:5px;" id="achTitle"></div>
            <div style="font-size:13px;color:var(--text-secondary);margin-bottom:15px;" id="achDesc"></div>
            <div style="display:inline-block;background:var(--accent);color:white;padding:8px 20px;border-radius:20px;font-weight:700;" id="achXP">+50 XP</div>
            <button class="btn btn-primary" onclick="closeModal('achievementModal')" style="margin-top:20px;width:100%;">رائع!</button>
        </div>
    </div>

    <div class="confirm-dialog" id="confirmDialog">
        <div class="confirm-dialog-icon" id="confirmIcon">🗑️</div>
        <div class="confirm-dialog-title" id="confirmTitle">حذف؟</div>
        <div class="confirm-dialog-text" id="confirmText">هل أنت متأكد؟</div>
        <div class="confirm-dialog-buttons">
            <button class="confirm-dialog-btn cancel" onclick="closeConfirm()">إلغاء</button>
            <button class="confirm-dialog-btn confirm" id="confirmBtn" onclick="doConfirm()">حذف</button>
        </div>
    </div>

    <div class="app-wrapper">
        <header class="app-header">
            <div class="header-top">
                <div class="header-logo">
                    <div class="header-logo-icon">🇮🇹</div>
                    <div>
                        <div class="header-title">سهل إيطالي</div>
                        <div class="header-subtitle">SahlItaly A1-B2</div>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="header-btn" onclick="openSection('achievements')"><i class="fas fa-trophy"></i><span class="badge" id="achBadge" style="display:none;">!</span></button>
                    <button class="header-btn" onclick="toggleNotif()"><i class="fas fa-bell"></i><span class="badge" id="notifBadge" style="display:none;">0</span></button>
                    <button class="header-btn" onclick="openSettings()"><i class="fas fa-cog"></i></button>
                </div>
            </div>
            <div class="stats-bar">
                <div class="stat-item"><i class="fas fa-fire"></i><span id="streakCount">0</span></div>
                <div class="stat-item"><i class="fas fa-star"></i><span id="xpCount">0</span> XP</div>
                <div class="stat-item"><i class="fas fa-trophy"></i>مستوى <span id="userLevel">1</span></div>
            </div>
        </header>

        <main class="main-content" id="mainContent"></main>

        <nav class="bottom-nav">
            <button class="nav-item active" data-page="home" onclick="navigateTo('home')"><i class="fas fa-home"></i><span>الرئيسية</span></button>
            <button class="nav-item" data-page="dictionary" onclick="navigateTo('dictionary')"><i class="fas fa-book-open"></i><span>القاموس</span></button>
            <button class="nav-item" data-page="grammar" onclick="navigateTo('grammar')"><i class="fas fa-book"></i><span>قواعد</span></button>
            <button class="nav-item" data-page="statistics" onclick="navigateTo('statistics')"><i class="fas fa-chart-bar"></i><span>إحصائيات</span></button>
            <button class="nav-item" data-page="profile" onclick="navigateTo('profile')"><i class="fas fa-user"></i><span>حسابي</span></button>
        </nav>
    </div>

    <script>
        // ==================== CONFIG ====================
        const CONFIG = {
            BASE_URL: 'https://raw.githubusercontent.com/Abdullahshanan/sahel-italia/master/',
            STATE_KEY: 'sahlitali_v12',
            CACHE_KEY: 'sahlitali_cache_v4'
        };

        // ==================== STATE ====================
        let state = {
            level: 'a1', darkMode: false, soundEnabled: true, notifEnabled: true,
            reminderTime: '09:00', dailyGoal: 50, xp: 0, streak: 0, longestStreak: 0,
            userLevel: 1, dailyXP: 0, lastStudyDate: null, learnedWords: {},
            quizzesDone: 0, perfectQuizzes: 0, correctAnswers: 0, totalQuestions: 0,
            likedWords: [], wodDate: null, wod: null, unlockedAch: [], newAch: [],
            dailyGoalCompleted: 0, weeklyXP: [0,0,0,0,0,0,0], totalDays: 0,
            wodCollapsed: false, notifications: [], openCats: {}, convSpeed: 1
        };

        let DB = { words: {}, grammar: {}, phrases: {}, conversations: {}, info: {} };
        let currentWords = [], wordIndex = 0, currentCat = null;
        let quizQs = [], quizIndex = 0, quizScore = 0, quizType = 'words';
        let exWords = [], exIndex = 0, exScore = 0, exType = '';
        let matchCards = [], firstCard = null, matchLocked = false, matchCount = 0, matchMoves = 0;
        let speedTimer = null, speedTime = 0, selectedLetters = [];
        let isListening = false, recognition = null;
        let dictLevel = null, currentConv = null, convPlaying = false;
        let pendingAction = null, pendingData = null;

        const ICONS = {
            greetings:'hand-wave', numbers:'hashtag', colors:'palette', family:'users',
            food:'utensils', drinks:'coffee', animals:'paw', body:'child', clothes:'tshirt',
            house:'home', weather:'cloud-sun', time:'clock', days:'calendar-day',
            months:'calendar-alt', professions:'briefcase', transport:'car', places:'map-marker-alt',
            verbs:'running', adjectives:'star', questions:'question-circle', shopping:'shopping-cart',
            restaurant:'utensils', hotel:'hotel', travel:'plane', health:'heartbeat',
            sports:'futbol', music:'music', nature:'tree', school:'graduation-cap',
            work:'building', emotions:'smile', directions:'compass', default:'folder'
        };

        const ACHIEVEMENTS = [
            {id:'first_word', icon:'📚', title:'الخطوة الأولى', desc:'تعلم أول كلمة', xp:10, check:s=>s.totalWords>=1},
            {id:'ten_words', icon:'🎯', title:'عشر كلمات', desc:'تعلم 10 كلمات', xp:25, check:s=>s.totalWords>=10},
            {id:'fifty_words', icon:'🌟', title:'خمسون كلمة', desc:'تعلم 50 كلمة', xp:50, check:s=>s.totalWords>=50},
            {id:'hundred_words', icon:'💯', title:'مئة كلمة', desc:'تعلم 100 كلمة', xp:100, check:s=>s.totalWords>=100},
            {id:'first_quiz', icon:'📝', title:'أول اختبار', desc:'أكمل اختبارك الأول', xp:15, check:s=>s.quizzesDone>=1},
            {id:'five_quizzes', icon:'🧠', title:'متعلم نشط', desc:'أكمل 5 اختبارات', xp:30, check:s=>s.quizzesDone>=5},
            {id:'perfect_quiz', icon:'🏆', title:'اختبار مثالي', desc:'احصل على 100%', xp:75, check:s=>s.perfectQuizzes>=1},
            {id:'streak_3', icon:'🔥', title:'ثلاثة أيام', desc:'تعلم 3 أيام متتالية', xp:20, check:s=>s.streak>=3},
            {id:'streak_7', icon:'⚡', title:'أسبوع كامل', desc:'تعلم 7 أيام متتالية', xp:50, check:s=>s.streak>=7},
            {id:'xp_100', icon:'⭐', title:'نجم صاعد', desc:'اجمع 100 XP', xp:20, check:s=>s.xp>=100},
            {id:'xp_500', icon:'🌠', title:'نجم متألق', desc:'اجمع 500 XP', xp:50, check:s=>s.xp>=500},
            {id:'liked_10', icon:'❤️', title:'محب الكلمات', desc:'أضف 10 كلمات للمفضلة', xp:25, check:s=>s.likedWords>=10}
        ];

        const LEVEL_COLORS = {
            a1: {color:'var(--a1-color)', gradient:'linear-gradient(135deg, #22C55E, #4ADE80)'},
            a2: {color:'var(--a2-color)', gradient:'linear-gradient(135deg, #3B82F6, #60A5FA)'},
            b1: {color:'var(--b1-color)', gradient:'linear-gradient(135deg, #F59E0B, #FBBF24)'},
            b2: {color:'var(--b2-color)', gradient:'linear-gradient(135deg, #EF4444, #F87171)'}
        };

        // ==================== HELPERS ====================
        const $ = id => document.getElementById(id);
        const $$ = sel => document.querySelectorAll(sel);
        const esc = s => s ? s.replace(/'/g, "\\'").replace(/"/g, '\\"') : '';
        const getIcon = (icon, catId) => {
            if(icon && /^[a-z-]+$/.test(icon)) return icon;
            if(catId) for(let k in ICONS) if(catId.toLowerCase().includes(k)) return ICONS[k];
            return ICONS.default;
        };

        function speak(text, rate=0.8) {
            if(state.soundEnabled && 'speechSynthesis' in window) {
                speechSynthesis.cancel();
                const u = new SpeechSynthesisUtterance(text);
                u.lang = 'it-IT'; u.rate = rate;
                speechSynthesis.speak(u);
            }
        }

        function toast(msg, type='info') {
            const t = $('toast'), icons = {success:'fa-check-circle', error:'fa-times-circle', warning:'fa-exclamation-triangle', info:'fa-info-circle'};
            $('toastMsg').textContent = msg;
            t.className = `toast ${type}`;
            t.querySelector('i').className = `fas ${icons[type]||icons.info}`;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2500);
        }

        function timeAgo(ts) {
            const s = Math.floor((Date.now()-ts)/1000);
            if(s<60) return 'الآن';
            if(s<3600) return `منذ ${Math.floor(s/60)} دقيقة`;
            if(s<86400) return `منذ ${Math.floor(s/3600)} ساعة`;
            return `منذ ${Math.floor(s/86400)} يوم`;
        }

        // ==================== STORAGE ====================
        function loadState() {
            try {
                const saved = localStorage.getItem(CONFIG.STATE_KEY);
                if(saved) state = {...state, ...JSON.parse(saved)};
            } catch(e) {}
            checkStreak();
        }

        function saveState() {
            try { localStorage.setItem(CONFIG.STATE_KEY, JSON.stringify(state)); } catch(e) {}
        }

        // ==================== DATA LOADING ====================
        async function loadJSON(path) {
            try {
                const res = await fetch(CONFIG.BASE_URL + path);
                if(!res.ok) throw new Error('Not found');
                return await res.json();
            } catch(e) { return null; }
        }

        async function loadData(type, level) {
            const key = `${type}_${level}`;
            if(DB[type][level]) return DB[type][level];
            
            const cached = localStorage.getItem(`${CONFIG.CACHE_KEY}_${key}`);
            if(cached) {
                try {
                    const {data, ts} = JSON.parse(cached);
                    if(Date.now()-ts < 86400000) { DB[type][level] = data; return data; }
                } catch(e) {}
            }
            
            const data = await loadJSON(`data/${type}/${level}.json`);
            if(data) {
                DB[type][level] = data;
                try { localStorage.setItem(`${CONFIG.CACHE_KEY}_${key}`, JSON.stringify({data, ts:Date.now()})); } catch(e) {}
            }
            return data;
        }

        async function loadInfo(page) {
            if(DB.info[page]) return DB.info[page];
            const data = await loadJSON(`data/info/${page}.json`);
            if(data) DB.info[page] = data;
            return data;
        }

        async function loadAllLevelData() {
            showLoader(true);
            await Promise.all([
                loadData('words', state.level),
                loadData('phrases', state.level),
                loadData('grammar', state.level),
                loadData('conversations', state.level)
            ]);
            showLoader(false);
            updateUI();
        }

        function showLoader(show) {
            let loader = $('miniLoader');
            if(!loader && show) {
                loader = document.createElement('div');
                loader.id = 'miniLoader';
                loader.className = 'mini-loader';
                loader.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري التحميل...';
                document.body.appendChild(loader);
            } else if(loader && !show) loader.remove();
        }

        // ==================== WORD OF DAY ====================
        function initWOD() {
            const today = new Date().toDateString();
            if(state.wodDate !== today) {
                const words = getAllWords();
                if(words.length) {
                    const day = Math.floor((new Date() - new Date(new Date().getFullYear(),0,0))/86400000);
                    state.wod = words[day % words.length];
                }
                state.wodDate = today;
                state.wodCollapsed = false;
                saveState();
            }
        }

        function getAllWords() {
            const words = [];
            for(let lvl in DB.words) {
                for(let catId in DB.words[lvl]) {
                    const cat = DB.words[lvl][catId];
                    if(cat.words) cat.words.forEach(w => words.push({...w, level:lvl, category:cat.name}));
                }
            }
            return words;
        }

        function getLevelWords() {
            const words = [];
            const data = DB.words[state.level] || {};
            for(let catId in data) {
                const cat = data[catId];
                if(cat.words) cat.words.forEach(w => words.push({...w, level:state.level, category:cat.name, catId}));
            }
            return words;
        }

        // ==================== NOTIFICATIONS ====================
        function addNotif(type, text, desc) {
            state.notifications.unshift({id:Date.now(), type, text, desc, time:Date.now(), read:false});
            if(state.notifications.length > 20) state.notifications = state.notifications.slice(0,20);
            saveState();
            updateNotifBadge();
        }

        function renderNotifications() {
            const list = $('notifList');
            if(!state.notifications.length) {
                list.innerHTML = '<div class="notif-empty"><i class="fas fa-bell-slash"></i><p>لا توجد إشعارات</p></div>';
                return;
            }
            const icons = {achievement:'🏆', streak:'🔥', xp:'⭐', reminder:'⏰', level:'🎉'};
            list.innerHTML = state.notifications.map(n => `
                <div class="notif-item ${n.read?'':'unread'}" onclick="markNotifRead(${n.id})">
                    <div class="notif-icon ${n.type}">${icons[n.type]||'📢'}</div>
                    <div class="notif-content">
                        <div class="notif-text">${n.text}</div>
                        <div class="notif-desc">${n.desc}</div>
                        <div class="notif-time">${timeAgo(n.time)}</div>
                    </div>
                </div>
            `).join('');
        }

        function markNotifRead(id) {
            const n = state.notifications.find(x=>x.id===id);
            if(n) { n.read=true; saveState(); updateNotifBadge(); renderNotifications(); }
        }

        function clearNotifications() {
            state.notifications = [];
            saveState();
            updateNotifBadge();
            renderNotifications();
            toast('تم مسح الإشعارات', 'success');
        }

        function toggleNotif() {
            const d = $('notifDropdown');
            d.classList.toggle('show');
            if(d.classList.contains('show')) renderNotifications();
        }

        function updateNotifBadge() {
            const badge = $('notifBadge');
            const count = state.notifications.filter(n=>!n.read).length;
            badge.textContent = count > 9 ? '9+' : count;
            badge.style.display = count > 0 ? 'flex' : 'none';
        }

        // ==================== ACHIEVEMENTS ====================
        function checkAchievements() {
            let totalWords = 0;
            Object.values(state.learnedWords).forEach(c => totalWords += Object.keys(c).length);
            const stats = {totalWords, quizzesDone:state.quizzesDone, perfectQuizzes:state.perfectQuizzes, streak:state.streak, xp:state.xp, likedWords:state.likedWords.length};
            
            ACHIEVEMENTS.forEach(a => {
                if(!state.unlockedAch.includes(a.id) && a.check(stats)) {
                    state.unlockedAch.push(a.id);
                    state.newAch.push(a.id);
                    state.xp += a.xp;
                    addNotif('achievement', `إنجاز جديد: ${a.title}`, a.desc);
                    showAchModal(a);
                }
            });
            updateAchBadge();
            saveState();
        }

        function showAchModal(a) {
            $('achIcon').textContent = a.icon;
            $('achTitle').textContent = a.title;
            $('achDesc').textContent = a.desc;
            $('achXP').textContent = '+' + a.xp + ' XP';
            openModal('achievementModal');
        }

        function updateAchBadge() {
            $('achBadge').style.display = state.newAch.length > 0 ? 'flex' : 'none';
        }

        // ==================== XP & STREAK ====================
        function checkStreak() {
            const today = new Date().toDateString();
            const yesterday = new Date(Date.now()-86400000).toDateString();
            if(state.lastStudyDate !== today) state.dailyXP = 0;
            if(state.lastStudyDate && state.lastStudyDate !== today && state.lastStudyDate !== yesterday) state.streak = 0;
        }

        function recordStudy() {
            const today = new Date().toDateString();
            const dow = new Date().getDay();
            if(state.lastStudyDate !== today) {
                const yesterday = new Date(Date.now()-86400000).toDateString();
                state.streak = (state.lastStudyDate === yesterday || !state.lastStudyDate) ? state.streak + 1 : 1;
                if(state.streak > state.longestStreak) state.longestStreak = state.streak;
                if([3,7,30].includes(state.streak)) addNotif('streak', `${state.streak} أيام متتالية! 🔥`, 'استمر في التعلم');
                state.lastStudyDate = today;
                state.totalDays++;
            }
            state.weeklyXP[dow] = (state.weeklyXP[dow]||0) + 1;
            saveState();
            updateUI();
        }

        function addXP(amount) {
            state.xp += amount;
            state.dailyXP += amount;
            state.weeklyXP[new Date().getDay()] = (state.weeklyXP[new Date().getDay()]||0) + amount;
            
            if(state.dailyXP >= state.dailyGoal && state.dailyXP - amount < state.dailyGoal) {
                state.dailyGoalCompleted++;
                addNotif('xp', 'أكملت هدفك اليومي! 🎯', `جمعت ${state.dailyGoal} XP`);
                toast('🎯 أكملت هدفك اليومي!', 'success');
            }
            
            const newLvl = Math.floor(state.xp/100) + 1;
            if(newLvl > state.userLevel) {
                state.userLevel = newLvl;
                addNotif('level', `وصلت للمستوى ${newLvl}! 🎉`, 'استمر في التعلم');
                toast(`🎉 وصلت للمستوى ${newLvl}!`, 'success');
            }
            
            recordStudy();
            checkAchievements();
            saveState();
            updateUI();
        }

        // ==================== LIKES ====================
        function toggleLike(word) {
            const idx = state.likedWords.findIndex(w=>w.it===word.it);
            if(idx===-1) { state.likedWords.push({...word}); toast('❤️ تمت الإضافة للمفضلة', 'success'); }
            else { state.likedWords.splice(idx,1); toast('تمت الإزالة من المفضلة', 'info'); }
            checkAchievements();
            saveState();
        }

        function isLiked(word) { return state.likedWords.some(w=>w.it===word.it); }

        // ==================== LEVEL PROGRESS ====================
        function calcProgress(level) {
            let total=0, learned=0;
            const cats = DB.words[level] || {};
            for(let catId in cats) {
                const cat = cats[catId];
                if(cat.words) {
                    total += cat.words.length;
                    learned += Object.keys(state.learnedWords[`${level}_${catId}`]||{}).length;
                }
            }
            return total > 0 ? Math.round((learned/total)*100) : 0;
        }

        // ==================== UI UPDATE ====================
        function updateUI() {
            $('streakCount').textContent = state.streak;
            $('xpCount').textContent = state.xp;
            $('userLevel').textContent = state.userLevel;
            updateNotifBadge();
            updateAchBadge();
        }

        // ==================== NAVIGATION ====================
        function navigateTo(page) {
            $$('.nav-item').forEach(n => n.classList.remove('active'));
            document.querySelector(`.nav-item[data-page="${page}"]`)?.classList.add('active');
            renderPage(page);
            $('mainContent').scrollTop = 0;
        }

        function openSection(section) { renderPage(section); $('mainContent').scrollTop = 0; }
        function goHome() { navigateTo('home'); }
        function goBack(to) { renderPage(to); $('mainContent').scrollTop = 0; }

        // ==================== MODALS ====================
        function openModal(id) {
            $('modalOverlay').classList.add('show');
            $(id).classList.add('show');
        }

        function closeModal(id) {
            $(id).classList.remove('show');
            $('modalOverlay').classList.remove('show');
        }

        function closeAllModals() {
            $$('.modal').forEach(m => m.classList.remove('show'));
            $('modalOverlay').classList.remove('show');
        }

        function showConfirm(icon, title, text, action, data) {
            $('confirmIcon').textContent = icon;
            $('confirmTitle').textContent = title;
            $('confirmText').textContent = text;
            pendingAction = action;
            pendingData = data;
            $('modalOverlay').classList.add('show');
            $('confirmDialog').classList.add('show');
        }

        function closeConfirm() {
            $('confirmDialog').classList.remove('show');
            $('modalOverlay').classList.remove('show');
            pendingAction = pendingData = null;
        }

        function doConfirm() {
            if(pendingAction === 'deleteLiked') {
                state.likedWords.splice(pendingData, 1);
                saveState();
                renderPage('favorites');
                toast('تم الحذف', 'success');
            } else if(pendingAction === 'reset') {
                localStorage.clear();
                location.reload();
            }
            closeConfirm();
        }

        // ==================== SETTINGS ====================
        async function openSettings() {
            const html = `
                <div class="settings-section">
                    <div class="settings-title">العرض</div>
                    <div class="settings-item" onclick="toggleDark()">
                        <div class="settings-item-info">
                            <div class="settings-item-icon"><i class="fas fa-moon"></i></div>
                            <div class="settings-item-text"><h4>الوضع الليلي</h4><p>تغيير مظهر التطبيق</p></div>
                        </div>
                        <div class="toggle ${state.darkMode?'active':''}" id="darkToggle"></div>
                    </div>
                    <div class="settings-item" onclick="toggleSound()">
                        <div class="settings-item-info">
                            <div class="settings-item-icon"><i class="fas fa-volume-up"></i></div>
                            <div class="settings-item-text"><h4>الأصوات</h4><p>تفعيل أصوات النطق</p></div>
                        </div>
                        <div class="toggle ${state.soundEnabled?'active':''}" id="soundToggle"></div>
                    </div>
                </div>
                <div class="settings-section">
                    <div class="settings-title">الإشعارات</div>
                    <div class="settings-item" onclick="toggleNotifSetting()">
                        <div class="settings-item-info">
                            <div class="settings-item-icon"><i class="fas fa-bell"></i></div>
                            <div class="settings-item-text"><h4>الإشعارات</h4><p>تذكيرات التعلم اليومية</p></div>
                        </div>
                        <div class="toggle ${state.notifEnabled?'active':''}" id="notifToggle"></div>
                    </div>
                </div>
                <div class="settings-section">
                    <div class="settings-title">الدراسة</div>
                    <div class="settings-item" onclick="setDailyGoal()">
                        <div class="settings-item-info">
                            <div class="settings-item-icon"><i class="fas fa-bullseye"></i></div>
                            <div class="settings-item-text"><h4>الهدف اليومي</h4><p id="goalDisplay">${state.dailyGoal} XP</p></div>
                        </div>
                        <i class="fas fa-chevron-left" style="color:var(--text-secondary)"></i>
                    </div>
                </div>
                <div class="settings-section">
                    <div class="settings-title">المعلومات</div>
                    <div class="settings-item" onclick="openInfoPage('about')">
                        <div class="settings-item-info">
                            <div class="settings-item-icon"><i class="fas fa-info-circle"></i></div>
                            <div class="settings-item-text"><h4>من نحن</h4><p>تعرف على التطبيق</p></div>
                        </div>
                        <i class="fas fa-chevron-left" style="color:var(--text-secondary)"></i>
                    </div>
                    <div class="settings-item" onclick="openInfoPage('contact')">
                        <div class="settings-item-info">
                            <div class="settings-item-icon"><i class="fas fa-envelope"></i></div>
                            <div class="settings-item-text"><h4>اتصل بنا</h4><p>تواصل معنا</p></div>
                        </div>
                        <i class="fas fa-chevron-left" style="color:var(--text-secondary)"></i>
                    </div>
                    <div class="settings-item" onclick="openInfoPage('privacy')">
                        <div class="settings-item-info">
                            <div class="settings-item-icon"><i class="fas fa-shield-alt"></i></div>
                            <div class="settings-item-text"><h4>سياسة الخصوصية</h4><p>كيف نحمي بياناتك</p></div>
                        </div>
                        <i class="fas fa-chevron-left" style="color:var(--text-secondary)"></i>
                    </div>
                    <div class="settings-item" onclick="openInfoPage('terms')">
                        <div class="settings-item-info">
                            <div class="settings-item-icon"><i class="fas fa-file-contract"></i></div>
                            <div class="settings-item-text"><h4>شروط الخدمة</h4><p>شروط الاستخدام</p></div>
                        </div>
                        <i class="fas fa-chevron-left" style="color:var(--text-secondary)"></i>
                    </div>
                </div>
                <div class="settings-section">
                    <div class="settings-title">البيانات</div>
                    <div class="settings-item" onclick="resetProgress()">
                        <div class="settings-item-info">
                            <div class="settings-item-icon" style="color:var(--danger)"><i class="fas fa-redo"></i></div>
                            <div class="settings-item-text"><h4>إعادة التقدم</h4><p>البدء من جديد</p></div>
                        </div>
                        <i class="fas fa-chevron-left" style="color:var(--text-secondary)"></i>
                    </div>
                </div>
                <div class="settings-section">
                    <div class="settings-title">تابعنا</div>
                    <div class="social-links">
                        <a href="#" class="social-link facebook"><i class="fab fa-facebook-f"></i></a>
                        <a href="#" class="social-link instagram"><i class="fab fa-instagram"></i></a>
                        <a href="#" class="social-link tiktok"><i class="fab fa-tiktok"></i></a>
                    </div>
                </div>
                <div class="app-version">سهل إيطالي - الإصدار 2.0.0</div>
            `;
            $('settingsContent').innerHTML = html;
            openModal('settingsModal');
        }

        function toggleDark() {
            state.darkMode = !state.darkMode;
            document.body.classList.toggle('dark-mode', state.darkMode);
            $('darkToggle')?.classList.toggle('active', state.darkMode);
            saveState();
        }

        function toggleSound() {
            state.soundEnabled = !state.soundEnabled;
            $('soundToggle')?.classList.toggle('active', state.soundEnabled);
            saveState();
            toast(state.soundEnabled ? '🔊 الصوت مفعّل' : '🔇 الصوت متوقف', 'info');
        }

        function toggleNotifSetting() {
            state.notifEnabled = !state.notifEnabled;
            $('notifToggle')?.classList.toggle('active', state.notifEnabled);
            saveState();
            toast(state.notifEnabled ? '🔔 الإشعارات مفعّلة' : '🔕 الإشعارات متوقفة', 'info');
        }

        function setDailyGoal() {
            const goals = [30, 50, 100, 150, 200];
            const idx = goals.indexOf(state.dailyGoal);
            state.dailyGoal = goals[(idx+1) % goals.length];
            $('goalDisplay').textContent = state.dailyGoal + ' XP';
            saveState();
            toast(`🎯 الهدف: ${state.dailyGoal} XP`, 'success');
        }

        function resetProgress() {
            showConfirm('⚠️', 'إعادة التعيين؟', 'سيتم حذف جميع بياناتك!', 'reset', null);
        }

        async function openInfoPage(page) {
            closeModal('settingsModal');
            const data = await loadInfo(page);
            if(data) {
                $('infoModalTitle').innerHTML = `<i class="fas ${data.icon}"></i> ${data.title}`;
                $('infoModalContent').innerHTML = `<div class="info-content">${data.content}</div>`;
            } else {
                $('infoModalTitle').textContent = 'خطأ';
                $('infoModalContent').innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>تعذر تحميل المحتوى</p></div>';
            }
            openModal('infoModal');
        }

        // ==================== PAGE RENDERERS ====================
        async function renderPage(page) {
            const main = $('mainContent');
            
            switch(page) {
                case 'home': main.innerHTML = await renderHome(); break;
                case 'dictionary': main.innerHTML = await renderDictionary(); break;
                case 'grammar': main.innerHTML = await renderGrammarList(); break;
                case 'statistics': main.innerHTML = renderStatistics(); break;
                case 'profile': main.innerHTML = renderProfile(); break;
                case 'words': main.innerHTML = await renderWordCategories(); break;
                case 'phrases': main.innerHTML = await renderPhrasesList(); break;
                case 'conversations': main.innerHTML = await renderConversationsList(); break;
                case 'quiz': main.innerHTML = renderQuizTypes(); break;
                case 'practice': main.innerHTML = renderPracticeTypes(); break;
                case 'achievements': main.innerHTML = renderAchievements(); break;
                case 'favorites': main.innerHTML = renderFavorites(); break;
                case 'wordStudy': main.innerHTML = renderWordStudy(); break;
                case 'quizPlay': main.innerHTML = renderQuizPlay(); break;
                default: main.innerHTML = await renderHome();
            }
        }

        async function renderHome() {
            await loadAllLevelData();
            initWOD();
            
            const wod = state.wod || {it:'Ciao', ar:'مرحباً', phonetic:'/ˈtʃaːo/', type:'تحية', example:{it:'Ciao, come stai?', ar:'مرحباً، كيف حالك؟'}};
            const today = new Date().toLocaleDateString('ar', {weekday:'long', day:'numeric', month:'long'});
            const progress = calcProgress(state.level);
            const wodLiked = isLiked(wod);
            
            let wordsCount=0, phrasesCount=0, convsCount=0, grammarCount=0;
            const words = DB.words[state.level] || {};
            for(let c in words) wordsCount += words[c].words?.length || 0;
            const phrases = DB.phrases[state.level] || [];
            phrases.forEach(p => phrasesCount += p.phrases?.length || 0);
            convsCount = (DB.conversations[state.level] || []).length;
            grammarCount = (DB.grammar[state.level] || []).length;
            
            let learnedCount = 0;
            for(let k in state.learnedWords) if(k.startsWith(state.level+'_')) learnedCount += Object.keys(state.learnedWords[k]).length;

            return `
                <div class="page active">
                    <!-- Word of Day -->
                    <div class="word-of-day ${state.wodCollapsed?'collapsed':''}" id="wod">
                        <div class="wod-header">
                            <div>
                                <div class="wod-badge">📖 كلمة اليوم</div>
                                <div class="wod-date">${today}</div>
                            </div>
                            <div class="wod-actions">
                                <button class="wod-btn ${wodLiked?'liked':''}" onclick="toggleWodLike(event)">
                                    <i class="${wodLiked?'fas':'far'} fa-heart"></i>
                                </button>
                                <button class="wod-btn" onclick="speak('${esc(wod.it)}')"><i class="fas fa-volume-up"></i></button>
                                <button class="wod-btn" onclick="toggleWod()"><i class="fas fa-chevron-${state.wodCollapsed?'down':'up'}" id="wodIcon"></i></button>
                            </div>
                        </div>
                        <div class="wod-content">
                            <div class="wod-italian">${wod.it}</div>
                            <div class="wod-phonetic">${wod.phonetic||''}</div>
                            <div class="wod-type">${wod.type||'كلمة'}</div>
                            <div class="wod-arabic">${wod.ar}</div>
                            ${wod.example ? `
                                <div class="wod-example">
                                    <div class="wod-example-label">مثال:</div>
                                    <div class="wod-example-it">${wod.example.it}</div>
                                    <div class="wod-example-ar">${wod.example.ar}</div>
                                </div>
                            ` : ''}
                        </div>
                        <div class="wod-collapsed">
                            <div class="wod-collapsed-text">
                                <span class="wod-collapsed-word">${wod.it}</span>
                                <span>-</span>
                                <span class="wod-collapsed-meaning">${wod.ar}</span>
                            </div>
                            <button class="wod-expand-btn" onclick="toggleWod()"><i class="fas fa-chevron-down"></i> عرض</button>
                        </div>
                    </div>

                    <!-- Daily Goal -->
                    <div class="daily-goal">
                        <div class="daily-goal-header">
                            <div class="daily-goal-title">🎯 هدفك اليومي</div>
                            <div class="daily-goal-xp">${state.dailyXP} / ${state.dailyGoal} XP</div>
                        </div>
                        <div class="daily-goal-progress">
                            <div class="daily-goal-fill" style="width:${Math.min((state.dailyXP/state.dailyGoal)*100, 100)}%"></div>
                        </div>
                    </div>

                    <!-- Level Selector -->
                    <div class="card">
                        <div class="card-title"><i class="fas fa-layer-group"></i> اختر المستوى</div>
                        <div class="level-tabs">
                            ${['a1','a2','b1','b2'].map(lvl => `
                                <div class="level-tab ${lvl} ${state.level===lvl?'active':''}" onclick="selectLevel('${lvl}')">
                                    ${lvl.toUpperCase()}
                                    <small>${{a1:'مبتدئ',a2:'أساسي',b1:'متوسط',b2:'متقدم'}[lvl]}</small>
                                    <div class="level-progress-bar">
                                        <div class="level-progress-fill" style="width:${calcProgress(lvl)}%"></div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Progress -->
                    <div class="card">
                        <div class="progress-header">
                            <div class="progress-title">تقدمك - ${state.level.toUpperCase()}</div>
                            <div class="progress-percentage">${progress}%</div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-bar-fill ${state.level}" style="width:${progress}%"></div>
                        </div>
                        <div class="progress-stats">
                            <div class="progress-stat"><div class="progress-stat-value">${learnedCount}</div><div class="progress-stat-label">كلمات</div></div>
                            <div class="progress-stat"><div class="progress-stat-value">0</div><div class="progress-stat-label">عبارات</div></div>
                            <div class="progress-stat"><div class="progress-stat-value">0</div><div class="progress-stat-label">قواعد</div></div>
                            <div class="progress-stat"><div class="progress-stat-value">${state.quizzesDone}</div><div class="progress-stat-label">اختبارات</div></div>
                        </div>
                    </div>

                    <!-- Section Cards -->
                    <div class="section-grid">
                        <div class="section-card words" onclick="openSection('words')">
                            <div class="section-card-icon"><i class="fas fa-font"></i></div>
                            <div class="section-card-title">الكلمات</div>
                            <div class="section-card-count">${wordsCount} كلمة</div>
                        </div>
                        <div class="section-card phrases" onclick="openSection('phrases')">
                            <div class="section-card-icon"><i class="fas fa-comment-dots"></i></div>
                            <div class="section-card-title">العبارات</div>
                            <div class="section-card-count">${phrasesCount} عبارة</div>
                        </div>
                        <div class="section-card conversations" onclick="openSection('conversations')">
                            <div class="section-card-icon"><i class="fas fa-comments"></i></div>
                            <div class="section-card-title">المحادثات</div>
                            <div class="section-card-count">${convsCount} محادثة</div>
                        </div>
                        <div class="section-card grammar" onclick="openSection('grammar')">
                            <div class="section-card-icon"><i class="fas fa-book"></i></div>
                            <div class="section-card-title">القواعد</div>
                            <div class="section-card-count">${grammarCount} درس</div>
                        </div>
                        <div class="section-card quiz" onclick="openSection('quiz')">
                            <div class="section-card-badge">جديد</div>
                            <div class="section-card-icon"><i class="fas fa-question-circle"></i></div>
                            <div class="section-card-title">اختبارات</div>
                            <div class="section-card-count">اختبر نفسك</div>
                        </div>
                        <div class="section-card practice" onclick="openSection('practice')">
                            <div class="section-card-icon"><i class="fas fa-dumbbell"></i></div>
                            <div class="section-card-title">تمارين</div>
                            <div class="section-card-count">تدرب يومياً</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function toggleWod() {
            state.wodCollapsed = !state.wodCollapsed;
            $('wod')?.classList.toggle('collapsed', state.wodCollapsed);
            const icon = $('wodIcon');
            if(icon) icon.className = `fas fa-chevron-${state.wodCollapsed?'down':'up'}`;
            saveState();
        }

        function toggleWodLike(e) {
            e.stopPropagation();
            if(state.wod) {
                toggleLike(state.wod);
                renderPage('home');
            }
        }

        async function selectLevel(level) {
            if(state.level === level) return;
            state.level = level;
            saveState();
            await loadAllLevelData();
            renderPage('home');
            toast(`تم التبديل للمستوى ${level.toUpperCase()}`, 'success');
        }

        // ==================== DICTIONARY ====================
        async function renderDictionary() {
            await loadAllLevelData();
            const lvl = dictLevel || state.level;
            const data = DB.words[lvl] || {};
            const cats = Object.keys(data);
            
            let counts = {a1:0, a2:0, b1:0, b2:0};
            for(let l of ['a1','a2','b1','b2']) {
                const d = DB.words[l] || {};
                for(let c in d) counts[l] += d[c].words?.length || 0;
            }

            return `
                <div class="page active">
                    <div class="page-header">
                        <button class="page-back" onclick="goHome()"><i class="fas fa-arrow-right"></i></button>
                        <div><div class="page-title">📚 القاموس</div><div class="page-subtitle">المستوى ${lvl.toUpperCase()}</div></div>
                    </div>
                    <div class="card">
                        <div class="dict-stats">
                            ${['a1','a2','b1','b2'].map(l => `
                                <div class="dict-stat ${l} ${lvl===l?'active':''}" onclick="filterDict('${l}')">
                                    <div class="dict-stat-value">${counts[l]}</div>
                                    <div class="dict-stat-label">${l.toUpperCase()}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" placeholder="ابحث في القاموس..." id="dictSearch" oninput="searchDict()">
                    </div>
                    <div id="dictContent">
                        ${cats.length ? cats.map(catId => {
                            const cat = data[catId];
                            const isOpen = state.openCats[`${lvl}_${catId}`];
                            const icon = getIcon(cat.icon, catId);
                            return `
                                <div class="dict-category ${isOpen?'open':''}" id="cat-${lvl}-${catId}">
                                    <div class="dict-category-header" onclick="toggleCat('${catId}','${lvl}')">
                                        <div class="dict-category-info">
                                            <div class="dict-category-icon" style="background:${LEVEL_COLORS[lvl].gradient}">
                                                <i class="fas fa-${icon}"></i>
                                            </div>
                                            <div class="dict-category-text">
                                                <h3>${cat.name}</h3>
                                                <span>${cat.words?.length||0} كلمة</span>
                                            </div>
                                        </div>
                                        <i class="fas fa-chevron-down dict-category-toggle"></i>
                                    </div>
                                    <div class="dict-category-content">
                                        ${(cat.words||[]).map(w => {
                                            const liked = isLiked(w);
                                            return `
                                                <div class="word-list-item">
                                                    <div class="word-list-level ${lvl}">${lvl.toUpperCase()}</div>
                                                    <div class="word-list-info">
                                                        <div class="word-list-italian">${w.it}</div>
                                                        <div class="word-list-arabic">${w.ar}</div>
                                                    </div>
                                                    <div class="word-list-actions">
                                                        <button class="word-list-btn speak" onclick="event.stopPropagation();speak('${esc(w.it)}')"><i class="fas fa-volume-up"></i></button>
                                                        <button class="word-list-btn like ${liked?'liked':''}" onclick="event.stopPropagation();toggleDictLike(this,'${esc(w.it)}','${catId}','${lvl}')">
                                                            <i class="${liked?'fas':'far'} fa-heart"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                            `;
                        }).join('') : '<div class="empty-state"><i class="fas fa-book-open"></i><p>لا توجد كلمات</p></div>'}
                    </div>
                </div>
            `;
        }

        function filterDict(level) { dictLevel = level; renderPage('dictionary'); }

        function toggleCat(catId, level) {
            const key = `${level}_${catId}`;
            state.openCats[key] = !state.openCats[key];
            saveState();
            $(`cat-${level}-${catId}`)?.classList.toggle('open', state.openCats[key]);
        }

        function toggleDictLike(btn, wordIt, catId, level) {
            const data = DB.words[level];
            const cat = data?.[catId];
            const word = cat?.words?.find(w=>w.it===wordIt);
            if(!word) return;
            toggleLike({...word, level, category:cat.name});
            const liked = isLiked(word);
            btn.classList.toggle('liked', liked);
            btn.innerHTML = `<i class="${liked?'fas':'far'} fa-heart"></i>`;
        }

        function searchDict() {
            const q = $('dictSearch')?.value.trim().toLowerCase();
            if(!q) { renderPage('dictionary'); return; }
            
            const results = [];
            for(let lvl of ['a1','a2','b1','b2']) {
                const data = DB.words[lvl] || {};
                for(let catId in data) {
                    const cat = data[catId];
                    cat.words?.forEach(w => {
                        if(w.it.toLowerCase().includes(q) || w.ar.includes(q))
                            results.push({...w, category:cat.name, catId, level:lvl});
                    });
                }
            }
            
            const content = $('dictContent');
            if(!results.length) { content.innerHTML = '<div class="empty-state"><i class="fas fa-search"></i><p>لا توجد نتائج</p></div>'; return; }
            
            content.innerHTML = results.map(w => {
                const liked = isLiked(w);
                return `
                    <div class="word-list-item">
                        <div class="word-list-level ${w.level}">${w.level.toUpperCase()}</div>
                        <div class="word-list-info">
                            <div class="word-list-italian">${w.it}</div>
                            <div class="word-list-arabic">${w.ar}</div>
                            <div class="word-list-category">${w.category}</div>
                        </div>
                        <div class="word-list-actions">
                            <button class="word-list-btn speak" onclick="speak('${esc(w.it)}')"><i class="fas fa-volume-up"></i></button>
                            <button class="word-list-btn like ${liked?'liked':''}" onclick="toggleDictLike(this,'${esc(w.it)}','${w.catId}','${w.level}')">
                                <i class="${liked?'fas':'far'} fa-heart"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ==================== WORDS ====================
        async function renderWordCategories() {
            const data = DB.words[state.level] || {};
            const cats = Object.keys(data);
            
            return `
                <div class="page active">
                    <div class="page-header">
                        <button class="page-back" onclick="goHome()"><i class="fas fa-arrow-right"></i></button>
                        <div><div class="page-title">الكلمات</div><div class="page-subtitle">المستوى ${state.level.toUpperCase()}</div></div>
                    </div>
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" placeholder="ابحث عن كلمة..." oninput="searchWords(this.value)">
                    </div>
                    <div class="category-list" id="wordCatList">
                        ${cats.length ? cats.map(catId => {
                            const cat = data[catId];
                            const count = cat.words?.length || 0;
                            const learned = Object.keys(state.learnedWords[`${state.level}_${catId}`]||{}).length;
                            const progress = count > 0 ? Math.round((learned/count)*100) : 0;
                            const icon = getIcon(cat.icon, catId);
                            return `
                                <div class="category-item" onclick="openWordCat('${catId}')">
                                    <div class="category-icon" style="background:${LEVEL_COLORS[state.level].gradient};color:white">
                                        <i class="fas fa-${icon}"></i>
                                    </div>
                                    <div class="category-info">
                                        <div class="category-name">${cat.name}</div>
                                        <div class="category-meta">${count} كلمة • ${learned} تعلمتها</div>
                                    </div>
                                    <div class="category-progress">${progress}%</div>
                                    <i class="fas fa-chevron-left category-arrow"></i>
                                </div>
                            `;
                        }).join('') : '<div class="empty-state"><i class="fas fa-book-open"></i><p>لا توجد كلمات</p></div>'}
                    </div>
                </div>
            `;
        }

        function openWordCat(catId) {
            const data = DB.words[state.level];
            if(!data?.[catId]) return;
            currentCat = catId;
            currentWords = [...data[catId].words].map(w => ({...w, level:state.level}));
            wordIndex = 0;
            renderPage('wordStudy');
        }

        function renderWordStudy() {
            if(!currentWords.length) return '<div class="page active"><div class="empty-state"><p>لا توجد كلمات</p></div></div>';
            const word = currentWords[wordIndex];
            const catName = DB.words[state.level]?.[currentCat]?.name || 'الكلمات';
            
            return `
                <div class="page active">
                    <div class="page-header">
                        <button class="page-back" onclick="openSection('words')"><i class="fas fa-arrow-right"></i></button>
                        <div><div class="page-title">${catName}</div><div class="page-subtitle">${wordIndex+1}/${currentWords.length}</div></div>
                    </div>
                    <div class="word-card-container">
                        <div class="word-card" id="wordCard" onclick="$('wordCard').classList.toggle('flipped')">
                            <div class="word-card-face word-card-front">
                                <div class="word-level-badge ${word.level||state.level}">${(word.level||state.level).toUpperCase()}</div>
                                <div class="word-type-badge">${word.type||'كلمة'}</div>
                                <div class="word-main">${word.it}</div>
                                <div class="word-phonetic">${word.phonetic||''}</div>
                                <div class="word-card-hint">انقر لرؤية الترجمة</div>
                            </div>
                            <div class="word-card-face word-card-back">
                                <div class="word-translation">${word.ar}</div>
                                ${word.example ? `<div class="word-example"><span style="direction:ltr;display:block">${word.example.it}</span><small>${word.example.ar}</small></div>` : ''}
                                <div class="word-card-hint">انقر للعودة</div>
                            </div>
                        </div>
                    </div>
                    <div class="word-controls">
                        <button class="btn btn-secondary" onclick="speak('${esc(word.it)}')"><i class="fas fa-volume-up"></i></button>
                        <button class="btn btn-secondary" onclick="prevWord()"><i class="fas fa-chevron-right"></i></button>
                        <button class="btn btn-secondary" onclick="nextWord()"><i class="fas fa-chevron-left"></i></button>
                        <button class="btn btn-primary" onclick="shuffleWords()"><i class="fas fa-random"></i></button>
                    </div>
                    <div class="rating-buttons">
                        <button class="rating-btn again" onclick="rateWord('again')"><i class="fas fa-redo"></i>أعد</button>
                        <button class="rating-btn hard" onclick="rateWord('hard')"><i class="fas fa-brain"></i>صعب</button>
                        <button class="rating-btn good" onclick="rateWord('good')"><i class="fas fa-thumbs-up"></i>جيد</button>
                        <button class="rating-btn easy" onclick="rateWord('easy')"><i class="fas fa-check-double"></i>سهل</button>
                    </div>
                </div>
            `;
        }

        function prevWord() { if(wordIndex > 0) { wordIndex--; renderPage('wordStudy'); } }
        function nextWord() {
            if(wordIndex < currentWords.length - 1) { wordIndex++; renderPage('wordStudy'); }
            else toast('🎉 انتهيت من هذه المجموعة!', 'success');
        }
        function shuffleWords() { currentWords.sort(()=>Math.random()-0.5); wordIndex=0; renderPage('wordStudy'); toast('🔀 تم الخلط', 'info'); }
        function rateWord(rating) {
            if(!currentWords.length) return;
            const word = currentWords[wordIndex];
            const key = `${word.level||state.level}_${currentCat}`;
            if(!state.learnedWords[key]) state.learnedWords[key] = {};
            state.learnedWords[key][word.it] = {rating, date:new Date().toISOString()};
            addXP({again:1, hard:3, good:5, easy:10}[rating]);
            nextWord();
        }

        // ==================== PHRASES ====================
        async function renderPhrasesList() {
            const phrases = DB.phrases[state.level] || [];
            return `
                <div class="page active">
                    <div class="page-header">
                        <button class="page-back" onclick="goHome()"><i class="fas fa-arrow-right"></i></button>
                        <div><div class="page-title">العبارات</div><div class="page-subtitle">المستوى ${state.level.toUpperCase()}</div></div>
                    </div>
                    <div class="category-list">
                        ${phrases.length ? phrases.map(p => `
                            <div class="category-item" onclick="openPhrases('${p.id}')">
                                <div class="category-icon" style="background:${LEVEL_COLORS.a2.gradient};color:white">
                                    <i class="fas fa-${getIcon(p.icon, p.id)}"></i>
                                </div>
                                <div class="category-info">
                                    <div class="category-name">${p.title}</div>
                                    <div class="category-meta">${p.phrases?.length||0} عبارة</div>
                                </div>
                                <i class="fas fa-chevron-left category-arrow"></i>
                            </div>
                        `).join('') : '<div class="empty-state"><i class="fas fa-comment"></i><p>لا توجد عبارات</p></div>'}
                    </div>
                </div>
            `;
        }

        function openPhrases(id) {
            const phrases = DB.phrases[state.level] || [];
            const cat = phrases.find(p=>p.id===id);
            if(!cat) return;
            
            const html = `
                <div class="page active">
                    <div class="page-header">
                        <button class="page-back" onclick="openSection('phrases')"><i class="fas fa-arrow-right"></i></button>
                        <div><div class="page-title">${cat.title}</div><div class="page-subtitle">تعلم العبارات</div></div>
                    </div>
                    ${cat.phrases.map(p => `
                        <div class="phrase-card">
                            <div class="phrase-header">
                                <div>
                                    <div class="phrase-italian">${p.it}</div>
                                    <div class="phrase-arabic">${p.ar}</div>
                                    <div class="phrase-phonetic">${p.phonetic||''}</div>
                                </div>
                                <button class="phrase-speak" onclick="speak('${esc(p.it)}')"><i class="fas fa-volume-up"></i></button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            $('mainContent').innerHTML = html;
            addXP(2);
        }

        // ==================== CONVERSATIONS ====================
        async function renderConversationsList() {
            const convs = DB.conversations[state.level] || [];
            return `
                <div class="page active">
                    <div class="page-header">
                        <button class="page-back" onclick="goHome()"><i class="fas fa-arrow-right"></i></button>
                        <div><div class="page-title">المحادثات</div><div class="page-subtitle">المستوى ${state.level.toUpperCase()}</div></div>
                    </div>
                    <div class="category-list">
                        ${convs.length ? convs.map(c => `
                            <div class="category-item" onclick="openConv('${c.id}')">
                                <div class="category-icon" style="background:${LEVEL_COLORS.b1.gradient};color:white">
                                    <i class="fas fa-${getIcon(c.icon, c.id)}"></i>
                                </div>
                                <div class="category-info">
                                    <div class="category-name">${c.title}</div>
                                    <div class="category-meta">${c.dialogue?.length||0} جملة</div>
                                </div>
                                <i class="fas fa-chevron-left category-arrow"></i>
                            </div>
                        `).join('') : '<div class="empty-state"><i class="fas fa-comments"></i><p>لا توجد محادثات</p></div>'}
                    </div>
                </div>
            `;
        }

        function openConv(id) {
            const convs = DB.conversations[state.level] || [];
            const conv = convs.find(c=>c.id===id);
            if(!conv) return;
            currentConv = conv;
            
            const html = `
                <div class="page active">
                    <div class="page-header">
                        <button class="page-back" onclick="openSection('conversations')"><i class="fas fa-arrow-right"></i></button>
                        <div><div class="page-title">${conv.title}</div><div class="page-subtitle">تدرب على المحادثة</div></div>
                    </div>
                    <div class="conv-container">
                        ${conv.dialogue.map((line, i) => `
                            <div class="conv-bubble person-${line.speaker.toLowerCase()}" id="conv-${i}">
                                <button class="conv-speak" onclick="speakLine(${i})"><i class="fas fa-volume-up"></i></button>
                                <div class="conv-speaker">${line.name}</div>
                                <div class="conv-text-it">${line.it}</div>
                                <div class="conv-text-ar">${line.ar}</div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="conv-controls">
                        <div class="conv-speed">
                            <span class="conv-speed-label">السرعة:</span>
                            <button class="conv-speed-btn ${state.convSpeed===0.7?'active':''}" onclick="setSpeed(0.7)">بطيء</button>
                            <button class="conv-speed-btn ${state.convSpeed===1?'active':''}" onclick="setSpeed(1)">عادي</button>
                            <button class="conv-speed-btn ${state.convSpeed===1.2?'active':''}" onclick="setSpeed(1.2)">سريع</button>
                        </div>
                        <button class="btn btn-primary" onclick="playConv()" id="playConvBtn" style="width:100%">
                            <i class="fas fa-play"></i> استمع للمحادثة كاملة
                        </button>
                    </div>
                </div>
            `;
            $('mainContent').innerHTML = html;
            addXP(3);
        }

        function speakLine(i) {
            if(!currentConv) return;
            const line = currentConv.dialogue[i];
            if(line) { speak(line.it, state.convSpeed); highlightLine(i); }
        }

        function highlightLine(i) {
            $$('.conv-bubble').forEach(el => { el.style.transform = 'scale(1)'; el.style.boxShadow = ''; });
            const el = $(`conv-${i}`);
            if(el) {
                el.style.transform = 'scale(1.02)';
                el.style.boxShadow = '0 4px 15px rgba(0,0,0,0.2)';
                el.scrollIntoView({behavior:'smooth', block:'center'});
            }
        }

        function setSpeed(speed) {
            state.convSpeed = speed;
            saveState();
            $$('.conv-speed-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
        }

        async function playConv() {
            if(!currentConv || convPlaying) return;
            convPlaying = true;
            const btn = $('playConvBtn');
            btn.innerHTML = '<i class="fas fa-stop"></i> إيقاف';
            btn.onclick = stopConv;
            
            const delay = 2500 / state.convSpeed;
            for(let i = 0; i < currentConv.dialogue.length; i++) {
                if(!convPlaying) break;
                highlightLine(i);
                speak(currentConv.dialogue[i].it, state.convSpeed);
                await new Promise(r => setTimeout(r, delay + currentConv.dialogue[i].it.length * 50));
            }
            stopConv();
        }

        function stopConv() {
            convPlaying = false;
            speechSynthesis.cancel();
            const btn = $('playConvBtn');
            if(btn) { btn.innerHTML = '<i class="fas fa-play"></i> استمع للمحادثة كاملة'; btn.onclick = playConv; }
            $$('.conv-bubble').forEach(el => { el.style.transform = 'scale(1)'; el.style.boxShadow = ''; });
        }

        // ==================== GRAMMAR ====================
        async function renderGrammarList() {
            const lessons = DB.grammar[state.level] || [];
            return `
                <div class="page active">
                    <div class="page-header">
                        <button class="page-back" onclick="goHome()"><i class="fas fa-arrow-right"></i></button>
                        <div><div class="page-title">القواعد</div><div class="page-subtitle">المستوى ${state.level.toUpperCase()}</div></div>
                    </div>
                    <div class="category-list">
                        ${lessons.length ? lessons.map(l => `
                            <div class="category-item" onclick="openGrammar('${l.id}')">
                                <div class="category-icon" style="background:${LEVEL_COLORS.b2.gradient};color:white">
                                    <i class="fas fa-${getIcon(l.icon, l.id)}"></i>
                                </div>
                                <div class="category-info">
                                    <div class="category-name">${l.title}</div>
                                    <div class="category-meta">${l.subtitle||''}</div>
                                </div>
                                <i class="fas fa-chevron-left category-arrow"></i>
                            </div>
                        `).join('') : '<div class="empty-state"><i class="fas fa-book"></i><p>لا توجد دروس</p></div>'}
                    </div>
                </div>
            `;
        }

        function openGrammar(id) {
            const lessons = DB.grammar[state.level] || [];
            const lesson = lessons.find(l=>l.id===id);
            if(!lesson?.content) return;
            
            let html = `
                <div class="page active">
                    <div class="page-header">
                        <button class="page-back" onclick="openSection('grammar')"><i class="fas fa-arrow-right"></i></button>
                        <div><div class="page-title">${lesson.title}</div><div class="page-subtitle">شرح القاعدة</div></div>
                    </div>
                    <div class="grammar-section">
                        <div class="grammar-section-title"><i class="fas fa-info-circle"></i> الشرح</div>
                        <p style="font-size:14px;line-height:1.8">${lesson.content.explanation}</p>
                    </div>
            `;
            
            if(lesson.content.table?.length) {
                html += `
                    <div class="grammar-section">
                        <div class="grammar-section-title"><i class="fas fa-table"></i> التصريف</div>
                        <table class="grammar-table">
                            <thead><tr><th>الضمير</th><th>التصريف</th><th>المعنى</th></tr></thead>
                            <tbody>${lesson.content.table.map(r => `<tr><td>${r.pronoun}</td><td class="italian-cell">${r.conjugation}</td><td>${r.meaning}</td></tr>`).join('')}</tbody>
                        </table>
                    </div>
                `;
            }
            
            if(lesson.content.examples?.length) {
                html += `
                    <div class="grammar-section">
                        <div class="grammar-section-title"><i class="fas fa-lightbulb"></i> أمثلة</div>
                        ${lesson.content.examples.map(ex => `
                            <div class="grammar-example">
                                <div class="grammar-example-it">${ex.it}<button onclick="speak('${esc(ex.it)}')" style="background:none;border:none;color:var(--primary);cursor:pointer;margin-right:10px"><i class="fas fa-volume-up"></i></button></div>
                                <div class="grammar-example-ar">${ex.ar}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            html += '</div>';
            $('mainContent').innerHTML = html;
            addXP(5);
        }

        // ==================== QUIZ ====================
        function renderQuizTypes() {
            const types = [
                {id:'words', icon:'fa-font', title:'اختبار الكلمات', desc:'10 أسئلة', color:LEVEL_COLORS.a1.gradient},
                {id:'reverse', icon:'fa-exchange-alt', title:'عربي ← إيطالي', desc:'10 أسئلة', color:LEVEL_COLORS.a2.gradient},
                {id:'listening', icon:'fa-headphones', title:'اختبار الاستماع', desc:'10 أسئلة', color:LEVEL_COLORS.b1.gradient},
                {id:'mixed', icon:'fa-random', title:'اختبار شامل', desc:'15 سؤال', color:LEVEL_COLORS.accent}
            ];
            return `
                <div class="page active">
                    <div class="page-header">
                        <button class="page-back" onclick="goHome()"><i class="fas fa-arrow-right"></i></button>
                        <div><div class="page-title">اختر نوع الاختبار</div><div class="page-subtitle">المستوى ${state.level.toUpperCase()}</div></div>
                    </div>
                    <div class="category-list">
                        ${types.map(t => `
                            <div class="category-item" onclick="startQuiz('${t.id}')">
                                <div class="category-icon" style="background:${t.color};color:white"><i class="fas ${t.icon}"></i></div>
                                <div class="category-info">
                                    <div class="category-name">${t.title}</div>
                                    <div class="category-meta">${t.desc}</div>
                                </div>
                                <i class="fas fa-chevron-left category-arrow"></i>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function startQuiz(type) {
            quizType = type;
            const words = getLevelWords();
            if(words.length < 4) { toast('لا توجد كلمات كافية', 'warning'); return; }
            
            quizQs = words.map(w => {
                if(type === 'reverse') return {q:`ما الترجمة الإيطالية لـ "${w.ar}"؟`, correct:w.it, opts:words.map(x=>x.it), audio:w.it, isIt:true};
                if(type === 'listening') return {q:'استمع واختر الترجمة الصحيحة', correct:w.ar, opts:words.map(x=>x.ar), audio:w.it};
                return {q:`ما معنى "<span style="direction:ltr;display:inline">${w.it}</span>"؟`, correct:w.ar, opts:words.map(x=>x.ar), audio:w.it};
            });
            
            quizQs = quizQs.sort(()=>Math.random()-0.5).slice(0, type==='mixed'?15:10);
            quizQs.forEach(q => {
                const wrong = q.opts.filter(o=>o!==q.correct).sort(()=>Math.random()-0.5).slice(0,3);
                q.opts = [q.correct, ...wrong].sort(()=>Math.random()-0.5);
            });
            
            quizIndex = 0;
            quizScore = 0;
            renderPage('quizPlay');
        }

        function renderQuizPlay() {
            const q = quizQs[quizIndex];
            const letters = ['أ','ب','ج','د'];
            
            return `
                <div class="page active">
                    <div class="page-header">
                        <button class="page-back" onclick="if(confirm('الخروج من الاختبار؟'))goHome()"><i class="fas fa-arrow-right"></i></button>
                        <div><div class="page-title">اختبار - ${state.level.toUpperCase()}</div></div>
                    </div>
                    <div class="card">
                        <div class="quiz-progress">
                            <span>${quizIndex+1}</span>
                            <div class="quiz-progress-bar"><div class="quiz-progress-fill" style="width:${((quizIndex+1)/quizQs.length)*100}%"></div></div>
                            <span>${quizQs.length}</span>
                        </div>
                        <div class="quiz-question">
                            <div class="quiz-question-text">${q.q}</div>
                            <div class="quiz-question-hint">${quizType==='listening'?'اضغط للاستماع':'اختر الإجابة الصحيحة'}</div>
                        </div>
                        ${quizType==='listening'?`<div style="text-align:center;margin-bottom:20px"><button class="listening-btn" onclick="speak('${esc(q.audio)}')"><i class="fas fa-volume-up"></i></button></div>`:''}
                        <div class="quiz-options" id="quizOpts">
                            ${q.opts.map((o,i) => `
                                <div class="quiz-option" onclick="selectAnswer(this,'${esc(o)}')">
                                    <div class="quiz-option-letter">${letters[i]}</div>
                                    <span class="quiz-option-text ${q.isIt?'italian-text':''}">${o}</span>
                                    ${q.isIt?`<button class="quiz-option-speak" onclick="event.stopPropagation();speak('${esc(o)}')"><i class="fas fa-volume-up"></i></button>`:''}
                                </div>
                            `).join('')}
                        </div>
                        <button class="btn btn-primary" id="quizNext" onclick="nextQuizQ()" style="display:none;width:100%">التالي <i class="fas fa-chevron-left"></i></button>
                    </div>
                </div>
            `;
        }

        function selectAnswer(el, answer) {
            const q = quizQs[quizIndex];
            $$('.quiz-option').forEach(o => o.classList.add('disabled'));
            el.classList.add('selected');
            state.totalQuestions++;
            
            if(answer === q.correct) {
                el.classList.add('correct');
                quizScore++;
                state.correctAnswers++;
                toast('✓ صحيح!', 'success');
            } else {
                el.classList.add('wrong');
                $$('.quiz-option').forEach(o => {
                    if(o.querySelector('.quiz-option-text').textContent === q.correct) o.classList.add('correct');
                });
                toast('✗ خطأ!', 'error');
            }
            
            const btn = $('quizNext');
            btn.style.display = 'block';
            btn.innerHTML = quizIndex < quizQs.length-1 ? 'التالي <i class="fas fa-chevron-left"></i>' : 'النتائج <i class="fas fa-trophy"></i>';
        }

        function nextQuizQ() {
            if(quizIndex < quizQs.length-1) { quizIndex++; renderPage('quizPlay'); }
            else showQuizResult();
        }

        function showQuizResult() {
            const pct = Math.round((quizScore/quizQs.length)*100);
            const xpEarned = quizScore * 5;
            if(pct === 100) state.perfectQuizzes++;
            
            let icon = '💪', title = 'حاول مجدداً!';
            if(pct >= 90) { icon = '🏆'; title = 'ممتاز!'; }
            else if(pct >= 70) { icon = '🎉'; title = 'جيد جداً!'; }
            else if(pct >= 50) { icon = '👍'; title = 'جيد!'; }
            
            state.quizzesDone++;
            addXP(xpEarned);
            
            $('mainContent').innerHTML = `
                <div class="page active">
                    <div class="card">
                        <div class="quiz-result">
                            <div class="quiz-result-icon">${icon}</div>
                            <div class="quiz-result-title">${title}</div>
                            <div class="quiz-result-score">${quizScore}/${quizQs.length} (${pct}%)</div>
                            <div class="quiz-result-stats">
                                <div class="quiz-result-stat"><div class="quiz-result-stat-value" style="color:var(--success)">${quizScore}</div><div class="quiz-result-stat-label">صحيح</div></div>
                                <div class="quiz-result-stat"><div class="quiz-result-stat-value" style="color:var(--danger)">${quizQs.length-quizScore}</div><div class="quiz-result-stat-label">خطأ</div></div>
                                <div class="quiz-result-stat"><div class="quiz-result-stat-value" style="color:var(--accent)">+${xpEarned}</div><div class="quiz-result-stat-label">XP</div></div>
                            </div>
                            <div style="display:flex;flex-direction:column;gap:8px">
                                <button class="btn btn-primary" onclick="startQuiz('${quizType}')" style="width:100%"><i class="fas fa-redo"></i> إعادة</button>
                                <button class="btn btn-secondary" onclick="goHome()" style="width:100%"><i class="fas fa-home"></i> الرئيسية</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // ==================== PRACTICE ====================
        function renderPracticeTypes() {
            const types = [
                {id:'flashcards', icon:'fa-clone', title:'بطاقات تعليمية', desc:'راجع الكلمات', color:LEVEL_COLORS.a1.gradient},
                {id:'spelling', icon:'fa-spell-check', title:'تمرين الإملاء', desc:'اكتب الكلمة', color:LEVEL_COLORS.a2.gradient},
                {id:'builder', icon:'fa-puzzle-piece', title:'تركيب الكلمات', desc:'رتب الحروف', color:LEVEL_COLORS.b1.gradient},
                {id:'matching', icon:'fa-th', title:'لعبة المطابقة', desc:'طابق الكلمات', color:LEVEL_COLORS.b2.gradient},
                {id:'listenWrite', icon:'fa-headphones', title:'تمرين الاستماع', desc:'استمع واكتب', color:'linear-gradient(135deg, #8B5CF6, #A855F7)'},
                {id:'speed', icon:'fa-bolt', title:'تحدي السرعة', desc:'أجب بسرعة', color:'linear-gradient(135deg, #F59E0B, #FB923C)'}
            ];
            return `
                <div class="page active">
                    <div class="page-header">
                        <button class="page-back" onclick="goHome()"><i class="fas fa-arrow-right"></i></button>
                        <div><div class="page-title">التمارين</div><div class="page-subtitle">المستوى ${state.level.toUpperCase()}</div></div>
                    </div>
                    <div class="category-list">
                        ${types.map(t => `
                            <div class="category-item" onclick="startExercise('${t.id}')">
                                <div class="category-icon" style="background:${t.color};color:white"><i class="fas ${t.icon}"></i></div>
                                <div class="category-info">
                                    <div class="category-name">${t.title}</div>
                                    <div class="category-meta">${t.desc}</div>
                                </div>
                                <i class="fas fa-chevron-left category-arrow"></i>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function startExercise(type) {
            const words = getLevelWords();
            if(words.length < 4) { toast('لا توجد كلمات كافية', 'warning'); return; }
            
            exWords = words.sort(()=>Math.random()-0.5).slice(0, type==='matching'?6:10);
            exIndex = 0;
            exScore = 0;
            exType = type;
            
            if(type === 'flashcards') {
                currentWords = exWords;
                wordIndex = 0;
                currentCat = 'practice';
                renderPage('wordStudy');
                return;
            }
            
            if(type === 'matching') { startMatching(); return; }
            if(type === 'speed') { startSpeed(); return; }
            
            renderExercise();
        }

        function renderExercise() {
            if(exIndex >= exWords.length) { showExResult(); return; }
            const word = exWords[exIndex];
            let content = '';
            
            if(exType === 'spelling' || exType === 'listenWrite') {
                content = `
                    <div class="exercise-card">
                        <div class="exercise-title">${exType==='spelling'?`اكتب الكلمة الإيطالية لـ:`:'استمع واكتب ما تسمعه'}</div>
                        ${exType==='spelling'?`<div style="font-size:24px;font-weight:800;text-align:center;margin-bottom:20px;color:var(--primary)">${word.ar}</div>`:''}
                        <div style="text-align:center"><button class="listening-btn" onclick="speak('${esc(word.it)}')"><i class="fas fa-volume-up"></i></button></div>
                        <div class="exercise-hint">💡 اضغط للاستماع</div>
                        <input type="text" class="exercise-input" id="exInput" placeholder="اكتب الكلمة..." autocomplete="off">
                        <button class="btn btn-primary" onclick="checkSpelling()" style="width:100%">تحقق <i class="fas fa-check"></i></button>
                    </div>
                `;
            } else if(exType === 'builder') {
                const letters = word.it.split('').sort(()=>Math.random()-0.5);
                selectedLetters = [];
                content = `
                    <div class="exercise-card">
                        <div class="exercise-title">رتب الحروف لتكوين الكلمة:</div>
                        <div style="font-size:20px;font-weight:700;text-align:center;margin-bottom:20px;color:var(--text-secondary)">${word.ar}</div>
                        <div class="answer-tiles" id="answerTiles"></div>
                        <div class="letter-tiles" id="letterTiles">
                            ${letters.map((l,i) => `<div class="letter-tile" data-idx="${i}" onclick="pickLetter(this,'${l}')">${l}</div>`).join('')}
                        </div>
                        <div style="display:flex;gap:10px;margin-top:15px">
                            <button class="btn btn-secondary" onclick="clearLetters()" style="flex:1"><i class="fas fa-undo"></i> مسح</button>
                            <button class="btn btn-primary" onclick="checkBuilder()" style="flex:1">تحقق <i class="fas fa-check"></i></button>
                        </div>
                    </div>
                `;
            }
            
            $('mainContent').innerHTML = `
                <div class="page active">
                    <div class="page-header">
                        <button class="page-back" onclick="openSection('practice')"><i class="fas fa-arrow-right"></i></button>
                        <div><div class="page-title">${{spelling:'تمرين الإملاء',builder:'تركيب الكلمات',listenWrite:'تمرين الاستماع'}[exType]}</div><div class="page-subtitle">${exIndex+1}/${exWords.length}</div></div>
                    </div>
                    ${content}
                </div>
            `;
            
            if(exType === 'listenWrite') setTimeout(()=>speak(word.it), 500);
            $('exInput')?.focus();
        }

        function checkSpelling() {
            const input = $('exInput');
            const word = exWords[exIndex];
            const answer = input.value.trim().toLowerCase();
            const correct = word.it.toLowerCase();
            
            if(answer === correct) {
                input.classList.add('correct');
                exScore++;
                addXP(5);
                toast('✓ صحيح!', 'success');
            } else {
                input.classList.add('wrong');
                toast(`✗ الإجابة: ${word.it}`, 'error');
            }
            setTimeout(() => { exIndex++; renderExercise(); }, 1500);
        }

        function pickLetter(el, letter) {
            if(el.classList.contains('disabled')) return;
            el.classList.add('disabled');
            selectedLetters.push({letter, el});
            
            const tile = document.createElement('div');
            tile.className = 'letter-tile selected';
            tile.textContent = letter;
            tile.onclick = () => { tile.remove(); el.classList.remove('disabled'); selectedLetters = selectedLetters.filter(l=>l.el!==el); };
            $('answerTiles').appendChild(tile);
        }

        function clearLetters() {
            $('answerTiles').innerHTML = '';
            $$('.letter-tile').forEach(t => t.classList.remove('disabled'));
            selectedLetters = [];
        }

        function checkBuilder() {
            const word = exWords[exIndex];
            const answer = selectedLetters.map(l=>l.letter).join('');
            
            if(answer.toLowerCase() === word.it.toLowerCase()) {
                exScore++;
                addXP(5);
                toast('✓ صحيح!', 'success');
            } else {
                toast(`✗ الإجابة: ${word.it}`, 'error');
            }
            selectedLetters = [];
            setTimeout(() => { exIndex++; renderExercise(); }, 1500);
        }

        // ==================== MATCHING GAME ====================
        function startMatching() {
            matchCards = [];
            exWords.forEach(w => {
                matchCards.push({text:w.it, pair:w.it, type:'it', matched:false});
                matchCards.push({text:w.ar, pair:w.it, type:'ar', matched:false});
            });
            matchCards = matchCards.sort(()=>Math.random()-0.5);
            firstCard = null;
            matchLocked = false;
            matchCount = 0;
            matchMoves = 0;
            
            renderMatching();
        }

        function renderMatching() {
            $('mainContent').innerHTML = `
                <div class="page active">
                    <div class="page-header">
                        <button class="page-back" onclick="openSection('practice')"><i class="fas fa-arrow-right"></i></button>
                        <div><div class="page-title">لعبة المطابقة</div><div class="page-subtitle">${matchCount}/${exWords.length}</div></div>
                    </div>
                    <div class="exercise-card">
                        <div class="exercise-title">طابق الكلمات الإيطالية بمعانيها العربية</div>
                        <div class="matching-stats">
                            <div class="matching-stat"><div class="matching-stat-value">${matchCount}/${exWords.length}</div><div class="matching-stat-label">أزواج</div></div>
                            <div class="matching-stat"><div class="matching-stat-value">${matchMoves}</div><div class="matching-stat-label">محاولات</div></div>
                        </div>
                        <div class="matching-game">
                            ${matchCards.map((c,i) => `
                                <div class="matching-card ${c.type==='it'?'italian-card':''} ${c.matched?'matched':''}" data-idx="${i}" onclick="pickCard(${i})">${c.text}</div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function pickCard(idx) {
            if(matchLocked || matchCards[idx].matched) return;
            const cardEl = document.querySelector(`.matching-card[data-idx="${idx}"]`);
            if(!cardEl || cardEl.classList.contains('flipped')) return;
            
            cardEl.classList.add('flipped');
            
            if(!firstCard) {
                firstCard = {idx, card:matchCards[idx], el:cardEl};
            } else {
                matchMoves++;
                if(firstCard.idx === idx) return;
                
                const card = matchCards[idx];
                if(firstCard.card.pair === card.pair && firstCard.card.type !== card.type) {
                    matchLocked = true;
                    setTimeout(() => {
                        firstCard.el.classList.remove('flipped');
                        firstCard.el.classList.add('matched');
                        cardEl.classList.remove('flipped');
                        cardEl.classList.add('matched');
                        matchCards[firstCard.idx].matched = true;
                        matchCards[idx].matched = true;
                        matchCount++;
                        addXP(5);
                        toast('✓ تطابق!', 'success');
                        firstCard = null;
                        matchLocked = false;
                        
                        if(matchCount === exWords.length) {
                            setTimeout(() => {
                                const bonus = Math.max(0, 30-matchMoves) * 2;
                                addXP(bonus);
                                toast(`🎉 أحسنت! ${matchMoves} محاولة`, 'success');
                                setTimeout(() => openSection('practice'), 1500);
                            }, 500);
                        } else {
                            renderMatching();
                        }
                    }, 300);
                } else {
                    matchLocked = true;
                    firstCard.el.classList.add('wrong');
                    cardEl.classList.add('wrong');
                    setTimeout(() => {
                        firstCard.el.classList.remove('flipped', 'wrong');
                        cardEl.classList.remove('flipped', 'wrong');
                        firstCard = null;
                        matchLocked = false;
                    }, 800);
                }
            }
        }

        // ==================== SPEED CHALLENGE ====================
        function startSpeed() {
            speedTime = 60;
            exIndex = 0;
            exScore = 0;
            
            speedTimer = setInterval(() => {
                speedTime--;
                const el = $('speedTimer');
                if(el) el.textContent = speedTime;
                if(speedTime <= 0) { clearInterval(speedTimer); showExResult(); }
            }, 1000);
            
            renderSpeedQ();
        }

        function renderSpeedQ() {
            if(exIndex >= exWords.length) { clearInterval(speedTimer); showExResult(); return; }
            const word = exWords[exIndex];
            const words = getLevelWords();
            const wrong = words.filter(w=>w.ar!==word.ar).sort(()=>Math.random()-0.5).slice(0,3);
            const opts = [word.ar, ...wrong.map(w=>w.ar)].sort(()=>Math.random()-0.5);
            
            $('mainContent').innerHTML = `
                <div class="page active">
                    <div class="page-header">
                        <button class="page-back" onclick="clearInterval(speedTimer);openSection('practice')"><i class="fas fa-arrow-right"></i></button>
                        <div><div class="page-title">تحدي السرعة</div><div class="page-subtitle">${exIndex+1}/${exWords.length}</div></div>
                    </div>
                    <div class="exercise-card">
                        <div style="display:flex;justify-content:space-between;margin-bottom:15px">
                            <div style="font-size:14px;font-weight:700">⏱️ <span id="speedTimer">${speedTime}</span> ثانية</div>
                            <div style="font-size:14px;font-weight:700">🎯 ${exScore} نقطة</div>
                        </div>
                        <div class="exercise-title">ما معنى "<span style="direction:ltr;display:inline">${word.it}</span>"؟</div>
                        <div class="quiz-options">
                            ${opts.map(o => `<div class="quiz-option" onclick="speedAnswer(this,'${esc(o)}','${esc(word.ar)}')"><span>${o}</span></div>`).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function speedAnswer(el, selected, correct) {
            $$('.quiz-option').forEach(o => o.classList.add('disabled'));
            if(selected === correct) { el.classList.add('correct'); exScore++; addXP(3); }
            else el.classList.add('wrong');
            setTimeout(() => { exIndex++; renderSpeedQ(); }, 500);
        }

        function showExResult() {
            if(speedTimer) clearInterval(speedTimer);
            const total = exWords.length;
            const pct = Math.round((exScore/total)*100);
            
            $('mainContent').innerHTML = `
                <div class="page active">
                    <div class="exercise-card" style="text-align:center">
                        <div style="font-size:50px;margin-bottom:15px">${pct>=70?'🎉':'💪'}</div>
                        <div style="font-size:22px;font-weight:800;margin-bottom:10px">${pct>=70?'ممتاز!':'أحسنت!'}</div>
                        <div style="font-size:18px;margin-bottom:20px">${exScore}/${total} (${pct}%)</div>
                        <button class="btn btn-primary" onclick="openSection('practice')" style="width:100%"><i class="fas fa-arrow-right"></i> العودة</button>
                    </div>
                </div>
            `;
        }

        // ==================== FAVORITES ====================
        function renderFavorites() {
            return `
                <div class="page active">
                    <div class="page-header">
                        <button class="page-back" onclick="navigateTo('profile')"><i class="fas fa-arrow-right"></i></button>
                        <div><div class="page-title">❤️ المفضلة</div><div class="page-subtitle">كلماتك المحفوظة</div></div>
                    </div>
                    <div class="favorites-header">
                        <div class="favorites-icon">❤️</div>
                        <div class="favorites-count">${state.likedWords.length}</div>
                        <div class="favorites-label">كلمة في المفضلة</div>
                        <div class="favorites-actions">
                            <button class="favorites-action-btn" onclick="studyFavorites()"><i class="fas fa-play"></i> دراسة</button>
                            <button class="favorites-action-btn" onclick="quizFavorites()"><i class="fas fa-question"></i> اختبار</button>
                        </div>
                    </div>
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" placeholder="ابحث في المفضلة..." oninput="searchFavs(this.value)">
                    </div>
                    <div id="favsList">
                        ${state.likedWords.length ? state.likedWords.map((w,i) => `
                            <div class="liked-word-item">
                                <div class="liked-word-icon">❤️</div>
                                <div class="liked-word-info">
                                    <div class="liked-word-it">${w.it}</div>
                                    <div class="liked-word-ar">${w.ar}</div>
                                    ${w.level?`<span class="liked-word-level ${w.level}">${w.level.toUpperCase()}</span>`:''}
                                </div>
                                <div class="liked-word-actions">
                                    <button class="liked-word-btn speak" onclick="speak('${esc(w.it)}')"><i class="fas fa-volume-up"></i></button>
                                    <button class="liked-word-btn delete" onclick="confirmDeleteFav(${i})"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                        `).join('') : '<div class="favorites-empty"><i class="far fa-heart"></i><p>لا توجد كلمات في المفضلة</p><button class="btn btn-primary" onclick="navigateTo(\'dictionary\')" style="margin:0 auto"><i class="fas fa-plus"></i> أضف كلمات</button></div>'}
                    </div>
                </div>
            `;
        }

        function searchFavs(q) {
            q = q.trim().toLowerCase();
            const filtered = q ? state.likedWords.filter(w => w.it.toLowerCase().includes(q) || w.ar.includes(q)) : state.likedWords;
            
            $('favsList').innerHTML = filtered.length ? filtered.map((w) => {
                const i = state.likedWords.findIndex(x=>x.it===w.it);
                return `
                    <div class="liked-word-item">
                        <div class="liked-word-icon">❤️</div>
                        <div class="liked-word-info">
                            <div class="liked-word-it">${w.it}</div>
                            <div class="liked-word-ar">${w.ar}</div>
                        </div>
                        <div class="liked-word-actions">
                            <button class="liked-word-btn speak" onclick="speak('${esc(w.it)}')"><i class="fas fa-volume-up"></i></button>
                            <button class="liked-word-btn delete" onclick="confirmDeleteFav(${i})"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                `;
            }).join('') : '<div class="empty-state"><i class="fas fa-search"></i><p>لا توجد نتائج</p></div>';
        }

        function confirmDeleteFav(i) {
            const w = state.likedWords[i];
            showConfirm('🗑️', 'حذف الكلمة؟', `هل تريد حذف "${w.it}" من المفضلة؟`, 'deleteLiked', i);
        }

        function studyFavorites() {
            if(!state.likedWords.length) { toast('لا توجد كلمات في المفضلة', 'warning'); return; }
            currentWords = [...state.likedWords];
            wordIndex = 0;
            currentCat = 'favorites';
            renderPage('wordStudy');
        }

        function quizFavorites() {
            if(state.likedWords.length < 4) { toast('تحتاج 4 كلمات على الأقل', 'warning'); return; }
            
            quizType = 'favorites';
            quizQs = state.likedWords.map(w => ({
                q: `ما معنى "<span style="direction:ltr;display:inline">${w.it}</span>"؟`,
                correct: w.ar,
                opts: state.likedWords.map(x=>x.ar),
                audio: w.it
            }));
            
            quizQs = quizQs.sort(()=>Math.random()-0.5).slice(0,10);
            quizQs.forEach(q => {
                const wrong = q.opts.filter(o=>o!==q.correct).sort(()=>Math.random()-0.5).slice(0,3);
                q.opts = [q.correct, ...wrong].sort(()=>Math.random()-0.5);
            });
            
            quizIndex = 0;
            quizScore = 0;
            renderPage('quizPlay');
        }

        // ==================== ACHIEVEMENTS ====================
        function renderAchievements() {
            let totalWords = 0;
            Object.values(state.learnedWords).forEach(c => totalWords += Object.keys(c).length);
            const stats = {totalWords, quizzesDone:state.quizzesDone, perfectQuizzes:state.perfectQuizzes, streak:state.streak, xp:state.xp, likedWords:state.likedWords.length};
            
            state.newAch = [];
            saveState();
            updateAchBadge();
            
            return `
                <div class="page active">
                    <div class="page-header">
                        <button class="page-back" onclick="goHome()"><i class="fas fa-arrow-right"></i></button>
                        <div><div class="page-title">🏆 الإنجازات</div><div class="page-subtitle">${state.unlockedAch.length}/12 مفتوحة</div></div>
                    </div>
                    <div class="achievements-grid">
                        ${ACHIEVEMENTS.map(a => {
                            const unlocked = state.unlockedAch.includes(a.id);
                            const progress = getAchProgress(a, stats);
                            return `
                                <div class="achievement-card ${unlocked?'unlocked':'locked'}">
                                    ${unlocked?'<div class="achievement-badge">✓</div>':''}
                                    <div class="achievement-xp">+${a.xp} XP</div>
                                    <div class="achievement-icon">${a.icon}</div>
                                    <div class="achievement-title">${a.title}</div>
                                    <div class="achievement-desc">${a.desc}</div>
                                    ${!unlocked?`<div class="achievement-progress"><div class="achievement-progress-fill" style="width:${progress}%"></div></div>`:''}
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        function getAchProgress(a, stats) {
            const targets = {first_word:1, ten_words:10, fifty_words:50, hundred_words:100, first_quiz:1, five_quizzes:5, perfect_quiz:1, streak_3:3, streak_7:7, xp_100:100, xp_500:500, liked_10:10};
            const values = {first_word:stats.totalWords, ten_words:stats.totalWords, fifty_words:stats.totalWords, hundred_words:stats.totalWords, first_quiz:stats.quizzesDone, five_quizzes:stats.quizzesDone, perfect_quiz:stats.perfectQuizzes, streak_3:stats.streak, streak_7:stats.streak, xp_100:stats.xp, xp_500:stats.xp, liked_10:stats.likedWords};
            const target = targets[a.id];
            const value = values[a.id];
            return target && value !== undefined ? Math.min((value/target)*100, 100) : 0;
        }

        // ==================== STATISTICS ====================
        function renderStatistics() {
            let totalWords = 0;
            Object.values(state.learnedWords).forEach(c => totalWords += Object.keys(c).length);
            const accuracy = state.totalQuestions > 0 ? Math.round((state.correctAnswers/state.totalQuestions)*100) : 0;
            const maxXP = Math.max(...state.weeklyXP, 50);
            const days = ['س','أ','إ','ث','أ','خ','ج'];
            
            return `
                <div class="page active">
                    <div class="page-header">
                        <button class="page-back" onclick="goHome()"><i class="fas fa-arrow-right"></i></button>
                        <div><div class="page-title">📊 الإحصائيات</div><div class="page-subtitle">تتبع تقدمك</div></div>
                    </div>
                    <div class="card">
                        <div class="card-title"><i class="fas fa-chart-pie"></i> نظرة عامة</div>
                        <div class="stats-grid">
                            <div class="stat-box"><div class="stat-box-icon">📚</div><div class="stat-box-value">${totalWords}</div><div class="stat-box-label">كلمة تعلمتها</div></div>
                            <div class="stat-box"><div class="stat-box-icon">⭐</div><div class="stat-box-value">${state.xp}</div><div class="stat-box-label">إجمالي XP</div></div>
                            <div class="stat-box"><div class="stat-box-icon">📝</div><div class="stat-box-value">${state.quizzesDone}</div><div class="stat-box-label">اختبار</div></div>
                            <div class="stat-box"><div class="stat-box-icon">🎯</div><div class="stat-box-value">${accuracy}%</div><div class="stat-box-label">دقة الإجابات</div></div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-title"><i class="fas fa-calendar-week"></i> نشاط الأسبوع</div>
                        <div class="weekly-chart">
                            ${state.weeklyXP.map((xp,i) => `
                                <div class="chart-bar" style="height:100%">
                                    <div class="chart-bar-fill" style="height:${maxXP>0?(xp/maxXP)*100:0}%"></div>
                                    <div class="chart-bar-label">${days[i]}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-title"><i class="fas fa-fire"></i> سلسلة التعلم</div>
                        <div class="stats-grid">
                            <div class="stat-box"><div class="stat-box-icon">🔥</div><div class="stat-box-value">${state.streak}</div><div class="stat-box-label">السلسلة الحالية</div></div>
                            <div class="stat-box"><div class="stat-box-icon">🏆</div><div class="stat-box-value">${state.longestStreak}</div><div class="stat-box-label">أطول سلسلة</div></div>
                            <div class="stat-box"><div class="stat-box-icon">📅</div><div class="stat-box-value">${state.totalDays}</div><div class="stat-box-label">أيام التعلم</div></div>
                            <div class="stat-box"><div class="stat-box-icon">🎯</div><div class="stat-box-value">${state.dailyGoalCompleted}</div><div class="stat-box-label">أهداف محققة</div></div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-title"><i class="fas fa-layer-group"></i> تقدم المستويات</div>
                        <div class="level-progress-card">
                            <div class="level-progress-item"><div class="level-progress-label" style="color:var(--a1-color)">A1</div><div class="level-progress-bar-sm"><div class="progress-bar-fill a1" style="width:${calcProgress('a1')}%"></div></div><div class="level-progress-value">${calcProgress('a1')}%</div></div>
                            <div class="level-progress-item"><div class="level-progress-label" style="color:var(--a2-color)">A2</div><div class="level-progress-bar-sm"><div class="progress-bar-fill a2" style="width:${calcProgress('a2')}%"></div></div><div class="level-progress-value">${calcProgress('a2')}%</div></div>
                        </div>
                        <div class="level-progress-card">
                            <div class="level-progress-item"><div class="level-progress-label" style="color:var(--b1-color)">B1</div><div class="level-progress-bar-sm"><div class="progress-bar-fill b1" style="width:${calcProgress('b1')}%"></div></div><div class="level-progress-value">${calcProgress('b1')}%</div></div>
                            <div class="level-progress-item"><div class="level-progress-label" style="color:var(--b2-color)">B2</div><div class="level-progress-bar-sm"><div class="progress-bar-fill b2" style="width:${calcProgress('b2')}%"></div></div><div class="level-progress-value">${calcProgress('b2')}%</div></div>
                        </div>
                    </div>
                </div>
            `;
        }

        // ==================== PROFILE ====================
        function renderProfile() {
            let totalWords = 0;
            Object.values(state.learnedWords).forEach(c => totalWords += Object.keys(c).length);
            const xpCurrent = state.xp % 100;
            
            return `
                <div class="page active">
                    <div class="profile-header">
                        <div class="profile-avatar">👨‍🎓</div>
                        <div class="profile-level">المستوى ${state.userLevel}</div>
                        <div class="profile-xp">${state.xp} XP</div>
                        <div class="profile-progress"><div class="profile-progress-fill" style="width:${xpCurrent}%"></div></div>
                        <div class="profile-next">${100-xpCurrent} XP للمستوى التالي</div>
                    </div>
                    <div class="card">
                        <div class="card-title">📊 الإحصائيات</div>
                        <div class="progress-stats">
                            <div class="progress-stat"><div class="progress-stat-value">${totalWords}</div><div class="progress-stat-label">كلمات</div></div>
                            <div class="progress-stat"><div class="progress-stat-value">${state.quizzesDone}</div><div class="progress-stat-label">اختبارات</div></div>
                            <div class="progress-stat"><div class="progress-stat-value">${state.streak}</div><div class="progress-stat-label">🔥 أيام</div></div>
                            <div class="progress-stat"><div class="progress-stat-value">${state.longestStreak}</div><div class="progress-stat-label">أطول سلسلة</div></div>
                        </div>
                    </div>
                    <div class="card" onclick="openSection('favorites')" style="cursor:pointer">
                        <div style="display:flex;justify-content:space-between;align-items:center">
                            <div class="card-title" style="margin:0">❤️ الكلمات المفضلة</div>
                            <div style="display:flex;align-items:center;gap:8px">
                                <span style="font-size:11px;color:var(--text-secondary)">${state.likedWords.length} كلمات</span>
                                <i class="fas fa-chevron-left" style="color:var(--text-secondary);font-size:12px"></i>
                            </div>
                        </div>
                        <div style="margin-top:10px">
                            ${state.likedWords.length ? state.likedWords.slice(0,3).map(w => `<span style="display:inline-block;background:var(--light);padding:5px 10px;border-radius:15px;margin:3px;font-size:12px">❤️ <span style="direction:ltr">${w.it}</span></span>`).join('') + (state.likedWords.length>3?`<span style="color:var(--text-secondary);font-size:11px;margin:3px">+${state.likedWords.length-3} أخرى</span>`:'') : '<div style="text-align:center;padding:10px;color:var(--text-secondary);font-size:12px">لا توجد كلمات مفضلة</div>'}
                        </div>
                    </div>
                </div>
            `;
        }

        // ==================== INIT ====================
        async function initApp() {
            loadState();
            if(state.darkMode) document.body.classList.add('dark-mode');
            
            await loadAllLevelData();
            
            $('loadingOverlay').classList.add('hide');
            
            navigateTo('home');
            updateUI();
            
            // Preload next level
            const levels = ['a1','a2','b1','b2'];
            const nextIdx = levels.indexOf(state.level) + 1;
            if(nextIdx < levels.length) {
                setTimeout(() => {
                    loadData('words', levels[nextIdx]);
                    loadData('phrases', levels[nextIdx]);
                }, 3000);
            }
        }

        // ==================== EVENT LISTENERS ====================
        window.addEventListener('online', () => { $('offlineBanner').classList.remove('show'); toast('🌐 تم استعادة الاتصال', 'success'); });
        window.addEventListener('offline', () => { $('offlineBanner').classList.add('show'); toast('📴 أنت غير متصل', 'warning'); });

        document.addEventListener('keydown', e => {
            if(e.key === 'Enter') {
                const input = $('exInput');
                if(input && document.activeElement === input) checkSpelling();
            }
        });

        // ==================== START ====================
        if(document.readyState === 'loading') document.addEventListener('DOMContentLoaded', initApp);
        else initApp();
    </script>
</body>
</html>